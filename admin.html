<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Calipso Bingo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: #1a5e3a !important; }
        .card-config { border-left: 5px solid #ffc107; }
        .card-winners { border-left: 5px solid #0d6efd; } 
        .btn-action { margin: 0 2px; }
        .row-verificado { background-color: #d1e7dd !important; }
        .badge-verificado { background-color: #198754; }
        .badge-pendiente { background-color: #ffc107; color: #000; }
        
        /* ESTILOS CALCULADORA */
        .prizes-panel { background-color: #2c3e50; color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .prize-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .prize-card.grand-prize { background: linear-gradient(135deg, #FF6B35, #e55a2b); border: none; transform: scale(1.05); box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4); }
        .prize-amount { font-size: 20px; font-weight: 800; display: block; margin-top: 5px; }
        .input-promedio { width: 80px; text-align: center; font-weight: bold; border-radius: 5px; border: none; padding: 2px; color: #333; }
        
        /* BARRA DE PROGRESO */
        .progress-container { margin-bottom: 20px; }
        .progress { height: 10px; border-radius: 5px; background-color: #e9ecef; }
        .progress-bar { background-color: #1a5e3a; transition: width 0.5s ease; }

        /* BUSCADOR TABLA */
        .search-panel { background: white; padding: 15px; border-bottom: 1px solid #eee; }

        /* Estilo para el toggle switch del modo mantenimiento */
        .maintenance-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff0f0; /* Fondo rojo claro para destacar */
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ffcccc;
        }
        .maintenance-label {
            margin: 0;
            font-weight: bold;
            color: #d32f2f;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: #d32f2f; /* Rojo cuando est√° activado */
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #d32f2f;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        .slider.round {
            border-radius: 24px;
        }
        .slider.round:before {
            border-radius: 50%;
        }

        /* --- ESTILOS DEL BINGO CALLER (INTEGRADO) --- */
        :root {
            --bg-color: #f4fdf9;
            --board-border: #1a5e3a;
            --primary-green: #1a5e3a;
            --accent-yellow: #fff200;       /* Amarillo Bingo */
            --accent-red: #dc3545;          /* Rojo (N√∫meros pasados) */
            --accent-blue: #0d6efd;
            --accent-grey: #adb5bd;
            --accent-green-light: #28a745; /* Verde (N√∫mero actual) */
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .bingo-game-container {
            background-color: var(--bg-color);
            width: 100%;
            height: 750px; /* Altura fija para el juego dentro del admin */
            position: relative;
            padding: 20px;
            overflow: hidden;
            border-radius: 8px;
            border: 1px solid #ddd;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        /* Ajuste para pantalla completa */
        .bingo-game-container:fullscreen {
            height: 100vh;
            width: 100vw;
            border: none;
            border-radius: 0;
            padding: 40px;
        }

        /* GRID PRINCIPAL JUEGO */
        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            grid-template-rows: auto 1fr;
            width: 100%;
            height: 100%; 
            max-width: 1600px;
            gap: 20px;
        }

        /* --- TABLERO (Izquierda) --- */
        .section-board {
            grid-column: 1 / 1;
            grid-row: 1 / 1;
            background: white;
            border: 4px solid var(--board-border);
            border-radius: 15px;
            padding: 8px;
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100%; /* Ajustado */
            min-height: 300px;
        }

        .board-table {
            display: grid;
            grid-template-rows: repeat(5, 1fr);
            gap: 4px;
            height: 100%;
        }

        .board-row {
            display: grid;
            grid-template-columns: 45px repeat(15, 1fr);
            gap: 2px;
        }

        /* Letras Laterales */
        .letter-box {
            display: flex; align-items: center; justify-content: center;
            color: white; font-weight: 900; font-size: 2.3rem;
            border-radius: 4px;
        }
        .lb-B { background-color: var(--accent-blue); }
        .lb-I { background-color: var(--accent-red); }
        .lb-N { background-color: var(--accent-grey); }
        .lb-G { background-color: var(--primary-green); }
        .lb-O { background-color: #ffc107; }

        /* --- FICHAS DEL TABLERO (PLANAS) --- */
        .num-cell {
            display: flex; 
            align-items: center; 
            justify-content: center;
            font-weight: 700; 
            font-size: 0.8rem; 
            color: #333;
            background: white; 
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .num-cell:hover { background-color: #f0f0f0; }

        .num-cell.called {
            background-color: var(--accent-red) !important;
            color: white !important;
            border: 1px solid var(--accent-red);
        }
        
        .num-cell.last {
            background-color: var(--accent-green-light) !important;
            color: white !important;
            transform: scale(1.15);
            z-index: 10;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .num-cell.winner {
            background-color: var(--accent-yellow) !important;
            color: black !important;
            border: 2px solid #333;
            animation: pulseWinner 1s infinite;
        }
        
        @keyframes pulseWinner {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* --- LATERAL DERECHO --- */
        .section-sidebar {
            grid-column: 2 / 3;
            grid-row: 1 / 3;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100%;
        }

        /* √ÅREA DEL LOGO (HEADER) */
        .logo-area {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 120px; 
            margin-bottom: 10px;
            position: relative;
        }
        
        .sidebar-logo {
            max-height: 100%;
            max-width: 90%;
            object-fit: contain;
            filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1));
        }

        .config-btn {
            position: absolute; top: 0; right: 0;
            background: var(--primary-green); color: white;
            border: none; width: 30px; height: 30px; border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }

        /* CARD DE BALOTA GRANDE */
        .ball-card {
            background: white; border-radius: 20px; padding: 25px;
            width: 100%; box-shadow: var(--shadow);
            display: flex; flex-direction: column; align-items: center;
            flex: 1; max-height: 650px; justify-content: center; gap: 20px;
        }

        /* --- BALOTAS 3D REDONDAS --- */
        .ball-container {
            position: relative; width: 180px; height: 180px;
            perspective: 1000px;
            margin-bottom: 10px;
        }

        .ball-3d {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            border-radius: 50%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            transform-style: preserve-3d;
            transition: transform 0.5s ease;
            box-shadow: 0 15px 30px rgba(0,0,0,0.3);
        }

        .ball-inner {
            position: absolute; width: 100%; height: 100%;
            border-radius: 50%;
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            backface-visibility: hidden;
            background: radial-gradient(circle at 35% 35%, rgba(255,255,255,0.8), rgba(255,255,255,0.1) 40%, rgba(0,0,0,0.2) 100%);
            box-shadow: inset -5px -5px 20px rgba(0,0,0,0.3);
            overflow: hidden;
            border: 1px solid rgba(0,0,0,0.1);
        }

        .ball-letter {
            font-size: 2.5rem; font-weight: 800; line-height: 1;
            margin-top: 10px; 
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
        }
        
        .ball-number {
            font-size: 6rem; font-weight: 900; line-height: 0.8;
            text-shadow: 0 1px 2px rgba(255,255,255,0.5);
        }

        /* Historial 3D */
        .mini-history { display: flex; gap: 8px; justify-content: center; }
        .mini-ball {
            width: 35px; height: 35px; 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; font-size: 0.8rem;
            box-shadow: inset -2px -2px 5px rgba(0,0,0,0.3), inset 2px 2px 5px rgba(255,255,255,0.4), 0 2px 4px rgba(0,0,0,0.2);
            color: white; text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Counter reducido */
        .counter-box {
            background-color: var(--accent-yellow); color: black;
            font-weight: 900; font-size: 1.3rem; 
            text-align: center;
            padding: 5px 12px; width: fit-content;
            border-radius: 6px;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        /* --- ZONA INFERIOR --- */
        .section-bottom {
            grid-column: 1 / 2; grid-row: 2 / 3;
            display: flex; gap: 20px; align-items: flex-start;
        }

        /* MODIFICADO: SAMPLE CARD BOX CON CURSOR POINTER */
        .sample-card-box {
            background: var(--primary-green); padding: 10px;
            border-radius: 10px; width: 300px; color: white; box-shadow: var(--shadow);
            min-height: 190px;
            cursor: pointer; /* Indica que es clicable */
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            position: relative;
        }
        
        .sample-card-box:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        
        .sample-card-box::after {
            content: 'Clic para cambiar';
            position: absolute;
            bottom: -25px;
            left: 0;
            width: 100%;
            text-align: center;
            font-size: 0.75rem;
            color: #666;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .sample-card-box:hover::after {
            opacity: 1;
        }
        
        /* Ajuste de t√≠tulo centrado en muestra */
        .sample-card-header { 
            font-weight: 800; 
            font-size: 1.1rem; 
            display: flex; 
            justify-content: center; /* CENTRADO */
            margin-bottom: 8px; 
            text-transform: uppercase;
        }
        
        .sample-grid {
            display: grid; grid-template-columns: repeat(5, 1fr); gap: 2px;
            background: white; padding: 2px;
            min-height: 140px;
        }
        .sample-cell {
            aspect-ratio: 1; background: white; border: 1px solid #ccc;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; color: #333; font-weight: bold;
        }
        .sample-cell.active-pattern { background: var(--accent-red) !important; color: white !important; }
        .sample-cell.center-free { background: url('Logo-oficial.png') center/cover no-repeat; }

        .info-center { flex: 1; display: flex; flex-direction: column; gap: 15px; }
        .details-row { display: flex; gap: 20px; width: 100%; }
        .detail-card {
            flex: 1; background: white; border-radius: 10px; padding: 10px 15px;
            box-shadow: var(--shadow); display: flex; flex-direction: column;
            justify-content: center; align-items: center; min-height: 80px;
        }
        .detail-label { color: #888; font-size: 0.8rem; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        .detail-value { font-size: 1.3rem; font-weight: 900; color: #333; }
        .detail-value.prize { color: var(--primary-green); }

        .controls-box {
            margin-top: auto; width: 100%; background: white;
            border: 1px solid var(--primary-green); border-radius: 10px; padding: 15px;
        }
        .radio-row { display: flex; justify-content: center; gap: 15px; margin-bottom: 10px; font-size: 0.9rem; }
        .btn-row { display: flex; gap: 10px; }
        .btn-game {
            flex: 1; padding: 12px; border: none; border-radius: 5px;
            font-weight: 800; text-transform: uppercase; color: white; cursor: pointer;
        }
        .btn-sacar { background-color: var(--primary-green); }
        .btn-bingo { background-color: var(--accent-yellow); color: black; }
        .btn-reset { width: 40px; background: #6c757d; flex: none; }

        /* Modal Config */
        .config-modal {
            position: absolute; top: 0; right: -320px; width: 300px; height: 100%;
            background: white; padding: 20px; box-shadow: -5px 0 20px rgba(0,0,0,0.2);
            transition: 0.3s; z-index: 1000; overflow-y: auto;
        }
        .config-modal.active { right: 0; }
        .form-group { margin-bottom: 10px; }
        .form-group label { display: block; font-weight: bold; font-size: 0.8rem; }
        .form-group input, .form-group select { width: 100%; padding: 5px; }

        /* Modal N√∫meros (Dise√±o Plano) */
        .numbers-modal {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 80%; max-width: 600px; max-height: 80%;
            background: white; border-radius: 15px; padding: 20px;
            border: 2px solid #333; /* Borde simple */
            box-shadow: none; /* Sin sombras */
            z-index: 2000; display: none; overflow: hidden;
            flex-direction: column;
        }
        .numbers-modal.active { display: flex; }
        .numbers-grid-history {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            gap: 10px; overflow-y: auto; padding: 10px; flex: 1;
        }
        /* Estilo plano para los n√∫meros en el modal */
        .numbers-grid-history .hist-ball {
            width: 50px; height: 50px; 
            border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            background: white !important;
            color: black !important;
            font-weight: bold; font-size: 1.2rem;
            border: 1px solid #ccc;
            box-shadow: none !important;
            text-shadow: none !important;
        }
        
        /* Modal Editor de Cartones (Split View) */
        .edit-layout {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        .edit-image-col {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            border-right: 1px solid #eee;
            padding-right: 20px;
        }
        .edit-inputs-col {
            flex: 1;
        }
        .carton-preview-img {
            max-width: 100%;
            max-height: 400px;
            object-fit: contain;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .edit-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 5px;
        }
        .edit-grid input {
            width: 100%;
            text-align: center;
            padding: 8px;
            font-weight: bold;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .edit-grid input:disabled {
            background-color: #e9ecef;
            color: #6c757d;
        }

        /* --- NUEVOS ESTILOS PARA EL MODAL DE FIGURAS --- */
        .pattern-modal-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            padding: 10px;
            max-height: 60vh;
            overflow-y: auto;
        }
        .pattern-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 5px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }
        .pattern-item:hover {
            border-color: var(--primary-green);
            background-color: #f0fdf4;
            transform: translateY(-2px);
        }
        .pattern-item.active {
            border: 2px solid var(--accent-yellow);
            background-color: #fff3cd;
        }
        .pattern-name {
            font-size: 0.7rem;
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .mini-pattern-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 1px;
            background: #ccc;
            border: 1px solid #ccc;
            aspect-ratio: 1;
        }
        .mini-pattern-cell {
            background: white;
            aspect-ratio: 1;
        }
        .mini-pattern-cell.active {
            background: var(--accent-red);
        }
        .mini-pattern-cell.free {
            background: #eee;
        }

        @keyframes float {
            0% { transform: translateY(0px) rotateX(0deg) rotateY(0deg); }
            50% { transform: translateY(-5px) rotateX(5deg); }
            100% { transform: translateY(0px) rotateX(0deg) rotateY(0deg); }
        }
        .floating { animation: float 3s ease-in-out infinite; }
        
        /* Loading Overlay */
        #loadingOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999; display: flex; justify-content: center; align-items: center;
            font-size: 2rem; font-weight: bold; color: var(--primary-green);
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-cogs"></i> Panel de Control</span>
            <div class="d-flex gap-2">
                <a href="index.html" class="btn btn-outline-light btn-sm" target="_blank">
                    <i class="fas fa-external-link-alt"></i> Ver Tienda
                </a>
                <a href="ganadores.html" class="btn btn-outline-warning btn-sm" target="_blank">
                    <i class="fas fa-trophy"></i> Ver Ganadores
                </a>
                <button class="btn btn-warning btn-sm fw-bold" onclick="window.location.href='index.html'">Salir</button>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div class="prizes-panel">
            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                <div>
                    <h5 class="m-0 fw-bold">üí∞ ESTRUCTURA DE PREMIOS (70%)</h5>
                    <small class="text-white-50">Tu Ganancia (30%): <span id="lblGanancia" class="fw-bold text-warning">Bs 0,00</span></small>
                </div>
                <div>
                    <small>Precio Promedio (Est.):</small>
                    <input type="number" id="inputPrecioPromedio" class="input-promedio" value="0" step="0.01" onchange="recalcularPremios()">
                </div>
            </div>
            <div class="row g-3">
                <div class="col-6 col-md-3"><div class="prize-card"><small class="text-uppercase text-white-50">1¬™ Tanda</small><span class="prize-amount" id="prizeT1">Bs 0,00</span></div></div>
                <div class="col-6 col-md-3"><div class="prize-card"><small class="text-uppercase text-white-50">2¬™ Tanda</small><span class="prize-amount" id="prizeT2">Bs 0,00</span></div></div>
                <div class="col-6 col-md-3"><div class="prize-card"><small class="text-uppercase text-white-50">3¬™ Tanda</small><span class="prize-amount" id="prizeT3">Bs 0,00</span></div></div>
                <div class="col-6 col-md-3"><div class="prize-card grand-prize"><small class="text-uppercase fw-bold">üëë CART√ìN LLENO</small><span class="prize-amount" id="prizeT4">Bs 0,00</span></div></div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 card-config">
            <div class="card-header bg-white fw-bold">
                <i class="fas fa-edit"></i> Configuraci√≥n del Sorteo
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4"><label class="form-label">T√≠tulo del Evento</label><input type="text" id="confTitulo" class="form-control" placeholder="Cargando..."></div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-danger">Fecha Sorteo</label>
                        <input type="text" id="confFecha" class="form-control" placeholder="Ej: 8 de Enero 2026">
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-bold text-danger">Hora Sorteo</label>
                        <input type="text" id="confHora" class="form-control" placeholder="Ej: 08:00 PM">
                    </div>

                    <div class="col-md-3"><label class="form-label fw-bold text-dark">üì¶ Total Cartones</label><input type="number" id="confTotalCartones" class="form-control" placeholder="Ej: 1000"></div>
                    
                    <div class="col-12 mt-3 mb-1">
                        <div class="form-check form-switch p-2 bg-light border rounded d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" id="toggleDescuentos" onchange="calcularPreciosAutomaticos()">
                            <label class="form-check-label fw-bold text-primary" for="toggleDescuentos">
                                ‚ú® Aplicar Descuentos Autom√°ticos (Si desactivas, cobra precio full)
                            </label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold text-success">Precio Base (1)</label>
                        <input type="number" id="confPrecioBase" class="form-control" step="0.01" placeholder="Ej: 50">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-secondary">Paquete x 4</label>
                        <input type="number" id="confPromo4" class="form-control" step="0.01" readonly style="background-color: #e8f5e9;">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-secondary">Paquete x 8</label>
                        <input type="number" id="confPromo8" class="form-control" step="0.01" readonly style="background-color: #e8f5e9;">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-secondary">Paquete x 12</label>
                        <input type="number" id="confPromo12" class="form-control" step="0.01" readonly style="background-color: #e8f5e9;">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label fw-bold text-primary">üéØ Configurar Tanda de Juego</label>
                        <select id="confTandaSelect" class="form-select" onchange="actualizarPremioConfig()">
                            <option value="t1">1¬™ Tanda</option>
                            <option value="t2">2¬™ Tanda</option>
                            <option value="t3">3¬™ Tanda</option>
                            <option value="t4" selected>üëë CART√ìN LLENO</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label fw-bold text-primary">Premio a Jugar</label>
                        <input type="text" id="confPremioDisplay" class="form-control fw-bold" style="background-color: #d1e7dd; color: #198754;" readonly value="Bs 0,00">
                    </div>
                    
                    <div class="col-12 mt-2">
                        <button class="btn btn-info btn-sm" onclick="crearCartonesEjemplo()">
                            <i class="fas fa-vial"></i> Crear Cartones de Prueba
                        </button>
                    </div>
                    
                    <div class="col-12">
                        <div class="maintenance-toggle-container">
                            <label for="mantenimientoToggle" class="maintenance-label"><i class="fas fa-ban"></i> Modo Mantenimiento (Cerrar Sitio):</label>
                            <label class="switch">
                                <input type="checkbox" id="mantenimientoToggle">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <div class="col-12 text-end mt-3">
                        <button class="btn btn-success fw-bold px-4" onclick="guardarConfiguracion()"><i class="fas fa-save"></i> ACTUALIZAR DATOS</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 card-winners">
            <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center flex-wrap gap-2">
                <div class="d-flex align-items-center gap-2">
                    <span><i class="fas fa-trophy"></i> GANADORES:</span>
                    <select id="filterWinners" class="form-select form-select-sm fw-bold text-primary" style="width: auto;" onchange="renderWinnersTable()">
                        <option value="all">Ver Todos</option>
                        <option value="1¬™ Tanda">1¬™ Tanda</option>
                        <option value="2¬™ Tanda">2¬™ Tanda</option>
                        <option value="3¬™ Tanda">3¬™ Tanda</option>
                        <option value="CART√ìN LLENO">üëë Cart√≥n Lleno</option>
                    </select>
                </div>
                <span class="badge bg-warning text-dark shadow-sm">
                    <i class="far fa-calendar-alt"></i> Sorteo: <span id="badgeFechaActiva">Cargando...</span>
                </span>
            </div>
            
            <div class="card-body">
                <p class="text-muted small mb-3">Los ganadores que registres aqu√≠ quedar√°n guardados bajo la fecha: <strong><span id="txtFechaConfirmacion">...</span></strong></p>
                
                <div class="row g-2 align-items-end mb-4 p-3 bg-light rounded border">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">1. Selecciona Premio</label>
                        <select id="selectTipoPremio" class="form-select form-select-sm" onchange="actualizarMontoPremio()">
                            <option value="">-- Manual --</option>
                            <option value="t1">1¬™ Tanda</option>
                            <option value="t2">2¬™ Tanda</option>
                            <option value="t3">3¬™ Tanda</option>
                            <option value="t4">üëë CART√ìN LLENO</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold small">2. N¬∫ Cart√≥n</label>
                        <input type="number" id="winCarton" class="form-control form-control-sm" placeholder="Ej: 154" onchange="buscarDue√±o()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Monto / Premio</label>
                        <input type="text" id="winPremio" class="form-control form-control-sm" placeholder="Se llena solo...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Ganador (Cliente)</label>
                        <input type="text" id="winNombre" class="form-control form-control-sm" placeholder="Se busca solo..." readonly style="background-color: #e9ecef;">
                    </div>
                    <div class="col-md-1">
                        <button onclick="agregarGanador()" class="btn btn-success btn-sm w-100 fw-bold" title="Guardar Ganador"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div>
                    <h6 class="text-muted border-bottom pb-2">üìã Lista de Ganadores Publicada</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha Sorteo</th>
                                    <th>Cart√≥n</th>
                                    <th>Premio</th>
                                    <th>Nombre del Ganador</th>
                                    <th style="width: 50px;">Borrar</th>
                                </tr>
                            </thead>
                            <tbody id="tableWinners">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <button class="btn btn-outline-danger btn-sm" onclick="resetearGanadores()">
                        <i class="fas fa-trash"></i> BORRAR TODOS LOS GANADORES
                    </button>
                </div>
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><div class="card bg-white p-3 shadow-sm text-center border-0 h-100"><h6 class="text-muted text-uppercase small">Total Vendidos</h6><h2 class="text-success fw-bold m-0" id="totalVendidos">0</h2><small class="fw-bold text-muted" id="lblPorcentaje" style="font-size: 14px;">0%</small></div></div>
            <div class="col-md-4"><div class="card bg-white p-3 shadow-sm text-center border-0 h-100"><h6 class="text-muted text-uppercase small">Recaudaci√≥n Total (Est.)</h6><h2 class="text-primary fw-bold" id="totalDinero">Bs 0,00</h2></div></div>
            <div class="col-md-4"><div class="card bg-white p-3 shadow-sm text-center border-0 h-100"><h6 class="text-muted text-uppercase small">Disponibles</h6><h2 class="text-secondary fw-bold" id="totalDisponibles">...</h2></div></div>
        </div>

        <div class="progress-container"><div class="progress"><div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div></div></div>

        <div class="card shadow-sm mb-4">
            <div class="card-header bg-dark text-white fw-bold d-flex justify-content-between align-items-center">
                <span><i class="fas fa-gamepad"></i> PANTALLA DE SORTEO</span>
                <button class="btn btn-sm btn-outline-light" onclick="toggleFullscreen()"><i class="fas fa-expand"></i> Pantalla Completa</button>
            </div>
            <div class="card-body p-0">
                <div class="bingo-game-container" id="bingoContainer">
                    <div class="dashboard-grid">
                        
                        <div class="section-board">
                            <div class="board-table" id="boardTable">
                            </div>
                        </div>

                        <div class="section-sidebar">
                            <div class="logo-area">
                                <img src="Logo-oficial-lineal.png" alt="Logo Bingo" class="sidebar-logo" id="mainLogo" onerror="this.src='https://via.placeholder.com/150x80?text=LOGO'">
                                <button class="config-btn" onclick="toggleConfig()"><i class="fas fa-cog"></i></button>
                            </div>

                            <div class="ball-card">
                                <div class="ball-container">
                                    <div class="ball-3d" id="ball3D">
                                        <div class="ball-inner" id="ballInner">
                                            <span class="ball-letter">G</span>
                                            <span class="ball-number">57</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mini-history" id="miniHistory">
                                    <div class="mini-ball">-</div><div class="mini-ball">-</div>
                                    <div class="mini-ball">-</div><div class="mini-ball">-</div>
                                </div>

                                <div class="d-flex justify-content-center align-items-center gap-2 mt-2 w-100">
                                    <div class="counter-box m-0">
                                        <span id="txtCounter">0 de 75</span>
                                    </div>
                                    <button class="btn btn-primary fw-bold btn-sm px-2 py-1" onclick="toggleNumbersModal()" title="Ver Historial" style="font-size: 0.9rem;">
                                        <i class="fas fa-list-ol"></i> VER N√öMEROS
                                    </button>
                                </div>

                                <div class="controls-box mt-3">
                                    <div class="mb-2">
                                        <label class="small fw-bold d-block text-center text-muted">JUGANDO POR:</label>
                                        <select id="gamePrizeSelect" class="form-select form-select-sm text-center fw-bold text-primary mb-2" onchange="updateGamePrizeDisplay()">
                                            <option value="t1" selected>1¬™ Tanda</option>
                                            <option value="t2">2¬™ Tanda</option>
                                            <option value="t3">3¬™ Tanda</option>
                                            <option value="t4">üëë CART√ìN LLENO</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="small fw-bold d-block text-center text-muted">FIGURA A JUGAR:</label>
                                        <select id="cfgPatternSelectMain" class="form-select form-select-sm text-center fw-bold bg-light" onchange="changePattern()">
                                        </select>
                                    </div>

                                    <div class="radio-row">
                                        <label><input type="radio" name="mode" checked onclick="setMode('manual')"> Manual</label>
                                        <label><input type="radio" name="mode" onclick="setMode('auto')"> Autom√°tico</label>
                                    </div>
                                    
                                    <div id="autoControls" style="display:none; text-align:center; margin-bottom:10px;">
                                        <input type="number" id="autoTime" value="4" min="4" style="width:50px;"> seg
                                        <button onclick="toggleAuto()" id="btnAutoToggle" style="cursor:pointer;">Start</button>
                                    </div>

                                    <div class="btn-row">
                                        <button class="btn-game btn-reset" onclick="resetGame()"><i class="fas fa-undo"></i></button>
                                        <button class="btn-game btn-sacar" id="btnDraw" onclick="drawBall()">SACAR BOLA</button>
                                        <button class="btn-game btn-bingo" onclick="toggleBingoAnim()">¬°BINGO!</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="section-bottom">
                            <div class="sample-card-box" onclick="openPatternModal()" title="Clic para cambiar figura">
                                <div class="sample-card-header">
                                    <span>FIGURA</span>
                                </div>
                                <div class="sample-grid" id="samplePatternGrid"></div>
                            </div>

                            <div class="info-center">
                                <div class="details-row">
                                    <div class="detail-card">
                                        <div class="detail-label">FIGURA</div>
                                        <div class="detail-value" id="lblFig">L√≠nea Horizontal 1</div>
                                    </div>
                                    <div class="detail-card">
                                        <div class="detail-label">PREMIO</div>
                                        <div class="detail-value prize" id="lblPrize">Bs 0,00</div>
                                    </div>
                                </div>
                                <div class="details-row mt-2">
                                    <div class="detail-card w-100" style="background: #e8f5e9; border: 1px solid #1a5e3a;">
                                        <div class="detail-label text-success">TANDA ACTUAL</div>
                                        <div class="detail-value text-success" id="lblTandaActiva">1¬™ Tanda</div>
                                    </div>
                                </div>
                                <button class="btn btn-info w-100 mt-3 fw-bold text-white shadow-sm" onclick="checkBingoWinner()" style="background-color: #0dcaf0; border: none; padding: 12px; font-size: 1.1rem; text-transform: uppercase;">
                                    <i class="fas fa-search me-2"></i> VER CART√ìN GANADOR
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="config-modal" id="configPanel">
                        <h3>Configuraci√≥n</h3>
                        <hr><br>
                        <div class="form-group">
                            <label>Logo URL</label>
                            <input type="text" id="cfgLogo" placeholder="Logo-oficial.png" oninput="updateUI()">
                        </div>
                        <div class="form-group">
                             <label>Seleccionar Figura</label>
                            <select id="cfgPatternSelect" onchange="changePattern()"></select>
                        </div>
                        <div class="form-group">
                            <label>Premio (Texto Manual - Opcional)</label>
                            <input type="text" id="cfgPrizeInput" oninput="updateUI()" value="Bs 100.00">
                        </div>
                        <div class="form-group">
                            <label>Color Principal (Verde)</label>
                            <input type="color" id="colPrim" value="#1a5e3a" oninput="updateColors()">
                        </div>
                        <div class="form-group">
                            <label>Color Fondo</label>
                            <input type="color" id="colBg" value="#f0fdf4" oninput="updateColors()">
                        </div>
                        <button class="btn-game btn-sacar" style="width:100%; margin-top:20px;" onclick="toggleConfig()">Cerrar</button>
                    </div>

                    <div class="numbers-modal" id="numbersModal">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h4 class="m-0 fw-bold">üìú Historial de Bolas (Orden de Salida)</h4>
                            <button class="btn btn-sm btn-danger" onclick="toggleNumbersModal()">x</button>
                        </div>
                        <div class="numbers-grid-history" id="numbersGridHistory">
                            </div>
                    </div>
                    
                    <div class="numbers-modal" id="editCardModal" style="z-index: 3100; max-width: 900px;">
                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <h3 class="m-0 fw-bold"><i class="fas fa-edit"></i> Editor de Cartones</h3>
                            <button class="btn btn-danger" onclick="toggleEditModal()"><i class="fas fa-times"></i></button>
                        </div>
                        <div class="p-2">
                            <div class="input-group mb-3">
                                <input type="number" id="editCardId" class="form-control" placeholder="N√∫mero de Cart√≥n (ej: 154)">
                                <button class="btn btn-primary" onclick="loadCardForEdit()">Cargar N√∫meros e Imagen</button>
                            </div>
                            
                            <div class="edit-layout">
                                <div class="edit-image-col">
                                    <h6 class="text-muted mb-2">Referencia Visual (JPG)</h6>
                                    <img id="editCardImage" src="Logo-oficial-lineal.png" class="carton-preview-img" onerror="this.src='https://via.placeholder.com/300x400?text=Sin+Imagen+Disponible'" crossorigin="anonymous">
                                    
                                    <div class="mt-2 text-center w-100">
                                        <label class="btn btn-sm btn-outline-primary w-100">
                                            <i class="fas fa-upload"></i> Subir Foto del Cart√≥n
                                            <input type="file" id="uploadCardImgInput" style="display: none;" accept="image/*" onchange="previewLocalImage(this)">
                                        </label>
                                        <small class="text-muted d-block mt-1" style="font-size: 0.75rem;">Si la imagen no carga, s√∫bela aqu√≠.</small>
                                    </div>
                                </div>
                                
                                <div class="edit-inputs-col">
                                    <h6 class="text-muted mb-2">Base de Datos (Corregir Aqu√≠)</h6>
                                    <div id="editGridContainer" class="edit-grid">
                                        </div>
                                    <div class="mt-4 text-end">
                                        <button class="btn btn-info fw-bold w-100 mb-2" onclick="autoDetectNumbers()">
                                            ‚ú® Auto-Leer con IA (OCR)
                                        </button>
                                        <button class="btn btn-success fw-bold w-100" onclick="saveCardNumbers()">
                                            <i class="fas fa-save"></i> GUARDAR CORRECCI√ìN
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="numbers-modal" id="patternSelectionModal" style="z-index: 3200; max-width: 800px; max-height: 90%;">
                        <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                            <h3 class="m-0 fw-bold"><i class="fas fa-th"></i> Seleccionar Figura</h3>
                            <button class="btn btn-danger" onclick="document.getElementById('patternSelectionModal').style.display='none'"><i class="fas fa-times"></i></button>
                        </div>
                        
                        <div class="mb-3 text-center">
                            <button class="btn btn-warning fw-bold w-100 py-2" onclick="selectRandomPattern()">
                                <i class="fas fa-random"></i> ¬°Elegir Figura Aleatoria!
                            </button>
                        </div>
                        
                        <div class="pattern-modal-grid" id="patternsGrid">
                            </div>
                    </div>

                </div>
            </div>
        </div>
        <div class="row mb-3">
            <div class="col-12 d-flex justify-content-between">
                <button class="btn btn-success fw-bold" onclick="descargarExcel()"><i class="fas fa-file-excel"></i> DESCARGAR LISTA SIMPLIFICADA</button>
                <button class="btn btn-outline-danger btn-sm" onclick="reiniciarVentas()"><i class="fas fa-trash-alt"></i> BORRAR VENTAS (RESET TOTAL)</button>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white fw-bold"><i class="fas fa-list"></i> Gesti√≥n de Ventas</div>
            
            <div class="search-panel">
                <div class="row g-2">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="buscadorVentas" class="form-control border-start-0" placeholder="Buscar por cliente, tel√©fono, referencia o # cart√≥n..." onkeyup="filtrarTabla()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="filtroEstado" class="form-select" onchange="filtrarTabla()">
                            <option value="todos">Todos los Estados</option>
                            <option value="pendientes">‚è≥ Solo Pendientes</option>
                            <option value="verificados">‚úÖ Solo Verificados</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light"><tr><th>Cart√≥n #</th><th>Cliente</th><th>Tel√©fono / Referencia</th><th>Estado</th><th class="text-end">Acciones</th></tr></thead>
                        <tbody id="tablaCuerpo"><tr><td colspan="5" class="text-center p-4 text-muted">Cargando datos...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="bingoWinnerModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content border-0 shadow-lg" style="overflow: hidden;">
                <div class="modal-header bg-success text-white justify-content-center py-2" style="background: linear-gradient(135deg, #1a5e3a 0%, #2E8B57 100%);"> <div class="text-center">
                        <h1 class="modal-title display-3 fw-bold text-warning mb-0" style="text-shadow: 2px 2px 4px rgba(0,0,0,0.3);">¬°BINGO!</h1> <p class="mb-0 fs-5">Tenemos Ganador</p>
                    </div>
                </div>
                <div class="modal-body bg-light" style="max-height: 70vh; overflow-y: auto;"> <div id="winnerModalContent" class="d-flex justify-content-center flex-wrap gap-3 py-2">
                        </div>
                    
                    <div class="row justify-content-center mt-2">
                        <div class="col-md-8">
                            <div class="card border-0 shadow-sm">
                                <div class="card-body py-2">
                                    <div class="row text-center">
                                        <div class="col-6 border-end">
                                            <small class="text-muted text-uppercase fw-bold">Figura</small>
                                            <div class="fs-5 fw-bold text-primary" id="modalPatternName">-</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted text-uppercase fw-bold">Premio</small>
                                            <div class="fs-5 fw-bold text-success" id="modalPrizeValue">-</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer justify-content-center bg-white py-2">
                    <button type="button" class="btn btn-dark px-4 rounded-pill" data-bs-dismiss="modal">Cerrar y Continuar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="loadingOverlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 9999; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: bold; color: var(--primary-green);">
        <i class="fas fa-circle-notch fa-spin me-3"></i> Cargando Sorteo...
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // CONTRASE√ëA DE ACCESO PARA EVITAR USO NO AUTORIZADO
        // Corregido: Verificaci√≥n simple de contrase√±a
        const pass = prompt("Ingrese contrase√±a de administrador:");
        if (btoa(pass) !== "YWRtaW4xMjM=") { // Contrase√±a: admin123
             alert("Contrase√±a incorrecta");
             window.location.href = "index.html";
        }

        const firebaseConfig = {
            apiKey: "AIzaSyBtj_J5wQ4y-U3UDwwphud9Wir1n7WcI2s",
            authDomain: "calipsobingo-f532b.firebaseapp.com",
            databaseURL: "https://calipsobingo-f532b-default-rtdb.firebaseio.com",
            projectId: "calipsobingo-f532b",
            storageBucket: "calipsobingo-f532b.firebasestorage.app",
            messagingSenderId: "196074596826",
            appId: "1:196074596826:web:db6280789eb0d51ddd38e3",
            measurementId: "G-M9XK1H641N"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const cartonesRef = database.ref('cartones');
        const configRef = database.ref('configuracion');
        const resultadosRef = database.ref('resultados'); 

        let precioBaseActual = 50;
        let totalCartonesGlobal = 1000;
        let totalVendidosCount = 0;
        let todosLosDatos = {}; 
        let valoresPremios = { t1: "Bs 0,00", t2: "Bs 0,00", t3: "Bs 0,00", t4: "Bs 0,00" };
        let primeraCarga = true; 
        let totalVentasAnterior = 0;
        let dataWarningShown = false; // Prevents spamming alerts

        // Helper to parse currency
        function parseCurrency(str) {
            if (!str) return 0;
            return parseFloat(str.replace(/[^\d,]/g, '').replace(',', '.'));
        }

        // Helper to format currency
        function formatCurrency(num) {
            return 'Bs ' + num.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2});
        }

        // --- C√ÅLCULO INTELIGENTE CON INTERRUPTOR ---
        function calcularPreciosAutomaticos() {
            const base = parseFloat(document.getElementById('confPrecioBase').value);
            const usarDescuentos = document.getElementById('toggleDescuentos').checked;

            if(!isNaN(base)) {
                if(usarDescuentos) {
                    // CON DESCUENTOS: 10%, 12.5%, 15%
                    document.getElementById('confPromo4').value = Math.round((base * 4) * 0.90);
                    document.getElementById('confPromo8').value = Math.round((base * 8) * 0.875);
                    document.getElementById('confPromo12').value = Math.round((base * 12) * 0.85);
                } else {
                    // SIN DESCUENTOS (Precio Full)
                    document.getElementById('confPromo4').value = base * 4;
                    document.getElementById('confPromo8').value = base * 8;
                    document.getElementById('confPromo12').value = base * 12;
                }

                // C√°lculo del Precio Promedio Unitario para la Calculadora
                const p4 = parseFloat(document.getElementById('confPromo4').value);
                const p8 = parseFloat(document.getElementById('confPromo8').value);
                const p12 = parseFloat(document.getElementById('confPromo12').value);
                
                // Promedio de los 4 escenarios (Unitario, y unitarios dentro de paquetes)
                const avgUnit = (base + (p4/4) + (p8/8) + (p12/12)) / 4;
                document.getElementById('inputPrecioPromedio').value = avgUnit.toFixed(2);
                
                recalcularPremios();
            }
        }

        // Event Listeners
        document.getElementById('confPrecioBase').addEventListener('input', calcularPreciosAutomaticos);

        function abrirWhatsApp(telefonoRaw, mensaje) {
            let telefono = telefonoRaw.replace(/\D/g, ''); 
            if (!telefono.startsWith('58')) telefono = '58' + telefono;
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            let url = isMobile 
                ? `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`
                : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        // --- MODIFICACI√ìN: L√ìGICA DE FILTRADO DE GANADORES ---
        let globalWinnersList = {}; // Variable para guardar los datos en memoria

        resultadosRef.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            globalWinnersList = data.ganadores || {}; // Guardamos los ganadores
            renderWinnersTable(); // Llamamos a la funci√≥n que pinta la tabla
        });

        // Funci√≥n para pintar la tabla aplicando el filtro
        function renderWinnersTable() {
            const tbodyWin = document.getElementById('tableWinners');
            const filterValue = document.getElementById('filterWinners').value; // Obtenemos qu√© tanda quiere ver el usuario
            
            tbodyWin.innerHTML = ''; // Limpiar tabla

            if (Object.keys(globalWinnersList).length > 0) {
                let hayResultados = false;

                Object.entries(globalWinnersList).forEach(([key, g]) => {
                    // L√ìGICA DE FILTRO:
                    // Si el filtro es "all" (todos), pasa.
                    // Si no, verificamos si el texto del premio (ej: "1¬™ Tanda - Bs 50") incluye la selecci√≥n.
                    const matchFilter = (filterValue === 'all') || (g.premio && g.premio.includes(filterValue));

                    if (matchFilter) {
                        hayResultados = true;
                        const tr = `<tr>
                            <td class="small text-muted fw-bold">${g.fecha || '-'}</td>
                            <td class="fw-bold text-center fs-5">#${g.carton}</td>
                            <td>${g.premio}</td>
                            <td>${g.nombre}</td>
                            <td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="borrarGanador('${key}')"><i class="fas fa-trash"></i></button></td>
                        </tr>`;
                        tbodyWin.innerHTML += tr;
                    }
                });

                if (!hayResultados) {
                    tbodyWin.innerHTML = `<tr><td colspan="5" class="text-center text-muted small p-3">No hay ganadores registrados para <strong>${filterValue}</strong>.</td></tr>`;
                }

            } else {
                tbodyWin.innerHTML = '<tr><td colspan="5" class="text-center text-muted small p-3">No hay ganadores registrados todav√≠a.</td></tr>';
            }
        }

        window.actualizarMontoPremio = function() {
            const seleccion = document.getElementById('selectTipoPremio').value;
            const inputPremio = document.getElementById('winPremio');
            if(seleccion && valoresPremios[seleccion]) {
                let etiqueta = "";
                if(seleccion === 't1') etiqueta = "1¬™ Tanda";
                if(seleccion === 't2') etiqueta = "2¬™ Tanda";
                if(seleccion === 't3') etiqueta = "3¬™ Tanda";
                if(seleccion === 't4') etiqueta = "CART√ìN LLENO";
                inputPremio.value = `${etiqueta} - ${valoresPremios[seleccion]}`;
            } else {
                inputPremio.value = "";
            }
        }

        // Nueva funci√≥n para actualizar el display de premio en la configuraci√≥n
        window.actualizarPremioConfig = function() {
            const sel = document.getElementById('confTandaSelect').value;
            if(valoresPremios && valoresPremios[sel]) {
                document.getElementById('confPremioDisplay').value = valoresPremios[sel];
                
                // Sincronizar tambi√©n con el select del juego si existe
                const gameSel = document.getElementById('gamePrizeSelect');
                if(gameSel) {
                    gameSel.value = sel;
                    updateGamePrizeDisplay();
                }
            }
        }

        window.buscarDue√±o = function() {
            const numeroCarton = document.getElementById('winCarton').value;
            const inputNombre = document.getElementById('winNombre');
            if(!numeroCarton) return;
            inputNombre.value = "Buscando...";
            inputNombre.style.backgroundColor = "#fff3cd"; 
            cartonesRef.child(numeroCarton).once('value').then((snapshot) => {
                const datos = snapshot.val();
                if(datos && datos.estado === 'vendido') {
                    inputNombre.value = datos.nombre || "Sin Nombre Registrado";
                    inputNombre.style.backgroundColor = "#d1e7dd"; 
                } else {
                    inputNombre.value = "‚ö†Ô∏è CART√ìN NO VENDIDO O LIBRE";
                    inputNombre.style.backgroundColor = "#f8d7da"; 
                }
            });
        }

        window.agregarGanador = function() {
            const c = document.getElementById('winCarton').value;
            const p = document.getElementById('winPremio').value;
            const n = document.getElementById('winNombre').value;
            const fechaMaestra = document.getElementById('confFecha').value;
            
            if (!fechaMaestra || fechaMaestra.trim() === "") {
                alert("‚õî ERROR: Debes escribir la 'Fecha Sorteo' en Configuraci√≥n antes de registrar ganadores.");
                document.getElementById('confFecha').focus();
                return;
            }
            
            if(c && p && n && !n.includes("NO VENDIDO")) {
                resultadosRef.child('ganadores').push({ carton: c, premio: p, nombre: n, fecha: fechaMaestra });
                document.getElementById('winCarton').value = '';
                document.getElementById('winPremio').value = '';
                document.getElementById('winNombre').value = '';
                document.getElementById('selectTipoPremio').value = '';
                document.getElementById('winNombre').style.backgroundColor = "#e9ecef";
            } else { alert("‚ö†Ô∏è Verifica los datos."); }
        }

        window.borrarGanador = function(key) { if(confirm('¬øEliminar ganador?')) resultadosRef.child('ganadores').child(key).remove(); }
        window.resetearGanadores = function() { if(confirm("‚ö†Ô∏è ¬øBorrar TODOS los ganadores?")) resultadosRef.child('ganadores').remove(); }
        
        configRef.on('value', (snapshot) => {
            const config = snapshot.val();
            if (config) {
                document.getElementById('confTitulo').value = config.titulo || '';
                const fechaCargada = config.fecha || '';
                document.getElementById('confFecha').value = fechaCargada;
                document.getElementById('confHora').value = config.hora || '';

                const badgeFecha = document.getElementById('badgeFechaActiva');
                const txtFechaConfirmacion = document.getElementById('txtFechaConfirmacion');
                
                if(fechaCargada) {
                    badgeFecha.textContent = fechaCargada;
                    txtFechaConfirmacion.textContent = fechaCargada;
                    badgeFecha.className = "badge bg-warning text-dark shadow-sm";
                } else {
                    badgeFecha.textContent = "SIN FECHA";
                    txtFechaConfirmacion.textContent = "SIN FECHA";
                    badgeFecha.className = "badge bg-danger text-white shadow-sm";
                }

                document.getElementById('confTotalCartones').value = config.totalCartones || 1000;
                document.getElementById('confPrecioBase').value = config.precioBase || 0;
                document.getElementById('confPromo4').value = config.promo4 || 0;
                document.getElementById('confPromo8').value = config.promo8 || 0;
                document.getElementById('confPromo12').value = config.promo12 || 0;
                
                // Cargar estado del switch de descuentos
                const usarDescuentos = config.usarDescuentos !== undefined ? config.usarDescuentos : true;
                document.getElementById('toggleDescuentos').checked = usarDescuentos;

                // NUEVO: Cargar estado del switch de mantenimiento
                const modoMantenimiento = config.modoMantenimiento !== undefined ? config.modoMantenimiento : false;
                document.getElementById('mantenimientoToggle').checked = modoMantenimiento;

                // Cargar Tanda Activa guardada si existe
                if(config.tandaActiva) {
                    document.getElementById('confTandaSelect').value = config.tandaActiva;
                }

                precioBaseActual = parseFloat(config.precioBase) || 0;
                totalCartonesGlobal = parseInt(config.totalCartones) || 1000;
                
                // Calcular promedio inicial
                const p4 = parseFloat(config.promo4) || 0;
                const p8 = parseFloat(config.promo8) || 0;
                const p12 = parseFloat(config.promo12) || 0;
                if(precioBaseActual > 0 && p4 > 0) {
                      const avgUnit = (precioBaseActual + (p4/4) + (p8/8) + (p12/12)) / 4;
                      document.getElementById('inputPrecioPromedio').value = avgUnit.toFixed(2);
                }

                recalcularPremios();
            }
        });

        window.guardarConfiguracion = function() {
            const datos = {
                titulo: document.getElementById('confTitulo').value,
                fecha: document.getElementById('confFecha').value,
                hora: document.getElementById('confHora').value,
                totalCartones: parseInt(document.getElementById('confTotalCartones').value),
                precioBase: parseFloat(document.getElementById('confPrecioBase').value),
                promo4: parseFloat(document.getElementById('confPromo4').value),
                promo8: parseFloat(document.getElementById('confPromo8').value),
                promo12: parseFloat(document.getElementById('confPromo12').value),
                usarDescuentos: document.getElementById('toggleDescuentos').checked,
                modoMantenimiento: document.getElementById('mantenimientoToggle').checked, // Guardamos estado del switch de mantenimiento
                tandaActiva: document.getElementById('confTandaSelect').value // NUEVO: Guardamos la tanda activa
            };
            configRef.set(datos).then(() => alert("‚úÖ Configuraci√≥n actualizada."));
        };

        cartonesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            todosLosDatos = data || {}; 
            const tabla = document.getElementById('tablaCuerpo');
            tabla.innerHTML = '';
            totalVendidosCount = 0;
            // Hide loading overlay
            document.getElementById('loadingOverlay').style.display = 'none';

            if (data) {
                const lista = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                lista.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                lista.forEach(item => {
                    if (item.estado === 'vendido') { 
                        totalVendidosCount++;
                        const esVerificado = item.verificado === true;
                        const claseFila = esVerificado ? 'row-verificado' : '';
                        const badgeEstado = esVerificado 
                            ? '<span class="badge badge-verificado"><i class="fas fa-check-circle"></i> Verificado</span>' 
                            : '<span class="badge badge-pendiente"><i class="fas fa-clock"></i> Pendiente</span>';

                        let mensajeWS = `Hola ${item.nombre}, te escribo de Calipso Bingo referente a tu cart√≥n #${item.id}...`;
                        const btnWhatsapp = `<a href="javascript:void(0)" onclick="abrirWhatsApp('${item.telefono}', '${mensajeWS}')" class="btn btn-success btn-sm btn-action" title="Chat WhatsApp"><i class="fab fa-whatsapp"></i></a>`;
                        const botonAccion = esVerificado
                            ? `<button class="btn btn-warning btn-sm btn-action" title="Desmarcar" onclick="toggleVerificado('${item.id}', false)"><i class="fas fa-undo"></i></button>`
                            : `<button class="btn btn-success btn-sm btn-action" title="Confirmar Pago" onclick="toggleVerificado('${item.id}', true)"><i class="fas fa-check"></i></button>`;

                        const tr = document.createElement('tr');
                        tr.className = claseFila;
                        tr.innerHTML = `<td><strong>#${item.id}</strong></td><td>${item.nombre}</td>
                            <td><small class="d-block text-muted">${item.telefono}</small><span class="fw-bold text-primary">Ref: ${item.referencia}</span></td>
                            <td>${badgeEstado}</td>
                            <td class="text-end">${btnWhatsapp}${botonAccion}<button class="btn btn-outline-danger btn-sm btn-action" onclick="liberar('${item.id}')"><i class="fas fa-times"></i></button></td>`;
                        tabla.appendChild(tr);
                    }
                });

                if (!primeraCarga && totalVendidosCount > totalVentasAnterior) {
                    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
                    audio.volume = 0.5;
                    audio.play().catch(e => console.log("Audio bloqueado"));
                }
                totalVentasAnterior = totalVendidosCount;
                primeraCarga = false;
            } else {
                tabla.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">No hay ventas registradas.</td></tr>';
            }
            recalcularPremios();
            filtrarTabla();
            // ACTUALIZAR CART√ìN DE EJEMPLO SI HAY DATOS
            changePattern();
        });

        function filtrarTabla() {
            const texto = document.getElementById('buscadorVentas').value.toLowerCase();
            const filtro = document.getElementById('filtroEstado').value;
            const filas = document.querySelectorAll('#tablaCuerpo tr');
            filas.forEach(fila => {
                if(fila.cells.length < 2) return;
                const textoFila = fila.innerText.toLowerCase();
                const esVerificado = fila.querySelector('.badge-verificado') !== null;
                const esPendiente = fila.querySelector('.badge-pendiente') !== null;
                let cumpleFiltro = true;
                if (filtro === 'pendientes' && !esPendiente) cumpleFiltro = false;
                if (filtro === 'verificados' && !esVerificado) cumpleFiltro = false;
                if (cumpleFiltro && !textoFila.includes(texto)) cumpleFiltro = false;
                fila.style.display = cumpleFiltro ? '' : 'none';
            });
        }

        window.recalcularPremios = function() {
            document.getElementById('totalVendidos').textContent = totalVendidosCount;
            document.getElementById('totalDisponibles').textContent = totalCartonesGlobal - totalVendidosCount;
            let porcentaje = totalCartonesGlobal > 0 ? (totalVendidosCount / totalCartonesGlobal) * 100 : 0;
            document.getElementById('lblPorcentaje').textContent = porcentaje.toFixed(1) + '% Vendido';
            document.getElementById('progressBar').style.width = porcentaje + '%';
            
            const precioPromedio = parseFloat(document.getElementById('inputPrecioPromedio').value) || precioBaseActual;
            const recaudadoTotal = totalVendidosCount * precioPromedio;
            
            // FORMATEO 2 DECIMALES
            const fmt = (val) => val.toLocaleString('es-VE', {minimumFractionDigits: 2, maximumFractionDigits: 2});

            document.getElementById('totalDinero').textContent = 'Bs ' + fmt(recaudadoTotal);

            const ganancia = recaudadoTotal * 0.30;
            const t1 = recaudadoTotal * 0.10;
            const t2 = recaudadoTotal * 0.10;
            const t3 = recaudadoTotal * 0.15;
            const t4 = recaudadoTotal * 0.35;

            valoresPremios.t1 = "Bs " + fmt(t1);
            valoresPremios.t2 = "Bs " + fmt(t2);
            valoresPremios.t3 = "Bs " + fmt(t3);
            valoresPremios.t4 = "Bs " + fmt(t4);

            document.getElementById('lblGanancia').textContent = 'Bs ' + fmt(ganancia);
            document.getElementById('prizeT1').textContent = valoresPremios.t1;
            document.getElementById('prizeT2').textContent = valoresPremios.t2;
            document.getElementById('prizeT3').textContent = valoresPremios.t3;
            document.getElementById('prizeT4').textContent = valoresPremios.t4;
            
            actualizarMontoPremio();
            updateGamePrizeDisplay(); // Actualizar premio en juego
            actualizarPremioConfig(); // Actualizar premio en configuraci√≥n
        }

        window.toggleVerificado = function(id, estado) { cartonesRef.child(id).update({ verificado: estado }); }
        window.liberar = function(id) { if(confirm('¬øEliminar venta del cart√≥n #' + id + '?')) cartonesRef.child(id).remove(); }
        window.reiniciarVentas = function() { if(confirm("‚ö†Ô∏è ¬øEst√°s seguro de borrar TODAS las ventas?")) { if(prompt("Escribe BORRAR para confirmar") === "BORRAR") cartonesRef.remove(); } }

        window.descargarExcel = function() {
            let csvContent = "data:text/csv;charset=utf-8,Carton;Nombre del Cliente\r\n";
            if(todosLosDatos) {
                const lista = Object.keys(todosLosDatos).map(key => ({ id: parseInt(key), ...todosLosDatos[key] }));
                lista.sort((a, b) => a.id - b.id);
                lista.forEach(item => {
                    if(item.estado === 'vendido') {
                        const nombreLimpio = (item.nombre || "Sin Nombre").replace(/;/g, " ");
                        csvContent += `${item.id};${nombreLimpio}\r\n`;
                    }
                });
            }
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "lista_simplificada_bingo.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- SCRIPTS DEL JUEGO DE BINGO INTEGRADO ---
        const letters = ['B', 'I', 'N', 'G', 'O'];
        const ranges = {
            'B': {min:1, max:15, color:'#0d6efd'},
            'I': {min:16, max:30, color:'#dc3545'},
            'N': {min:31, max:45, color:'#adb5bd'},
            'G': {min:46, max:60, color:'#1a5e3a'},
            'O': {min:61, max:75, color:'#ffc107'}
        };

        const patternsDB = {
            "L√≠nea Horizontal 1": [1,1,1,1,1, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
            "Cart√≥n Lleno": [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1],
            "L√≠nea Horizontal 2": [0,0,0,0,0, 1,1,1,1,1, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0],
            "L√≠nea Horizontal 3": [0,0,0,0,0, 0,0,0,0,0, 1,1,1,1,1, 0,0,0,0,0, 0,0,0,0,0],
            "L√≠nea Horizontal 4": [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 1,1,1,1,1, 0,0,0,0,0],
            "L√≠nea Horizontal 5": [0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 1,1,1,1,1],
            "L√≠nea Vertical B": [1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0],
            "L√≠nea Vertical I": [0,1,0,0,0, 0,1,0,0,0, 0,1,0,0,0, 0,1,0,0,0, 0,1,0,0,0],
            "L√≠nea Vertical N": [0,0,1,0,0, 0,0,1,0,0, 0,0,1,0,0, 0,0,1,0,0, 0,0,1,0,0],
            "L√≠nea Vertical G": [0,0,0,1,0, 0,0,0,1,0, 0,0,0,1,0, 0,0,0,1,0, 0,0,0,1,0],
            "L√≠nea Vertical O": [0,0,0,0,1, 0,0,0,0,1, 0,0,0,0,1, 0,0,0,0,1, 0,0,0,0,1],
            "Diagonal Principal": [1,0,0,0,0, 0,1,0,0,0, 0,0,1,0,0, 0,0,0,1,0, 0,0,0,0,1],
            "Diagonal Inversa": [0,0,0,0,1, 0,0,0,1,0, 0,0,1,0,0, 0,1,0,0,0, 1,0,0,0,0],
            "Letra X": [1,0,0,0,1, 0,1,0,1,0, 0,0,1,0,0, 0,1,0,1,0, 1,0,0,0,1],
            "Cruz Grande": [0,0,1,0,0, 0,0,1,0,0, 1,1,1,1,1, 0,0,1,0,0, 0,0,1,0,0],
            "Cuatro Esquinas": [1,0,0,0,1, 0,0,0,0,0, 0,0,0,0,0, 0,0,0,0,0, 1,0,0,0,1],
            "Marco Grande": [1,1,1,1,1, 1,0,0,0,1, 1,0,0,0,1, 1,0,0,0,1, 1,1,1,1,1],
            "Marco Peque√±o": [0,0,0,0,0, 0,1,1,1,0, 0,1,0,1,0, 0,1,1,1,0, 0,0,0,0,0],
            "Letra A": [1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1, 1,0,0,0,1, 1,0,0,0,1],
            "Letra B": [1,1,1,1,0, 1,0,0,0,1, 1,1,1,1,0, 1,0,0,0,1, 1,1,1,1,0],
            "Letra C": [1,1,1,1,1, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,1,1,1,1],
            "Letra D": [1,1,1,1,0, 1,0,0,0,1, 1,0,0,0,1, 1,0,0,0,1, 1,1,1,1,0],
            "Letra E": [1,1,1,1,1, 1,0,0,0,0, 1,1,1,1,1, 1,0,0,0,0, 1,1,1,1,1],
            "Letra F": [1,1,1,1,1, 1,0,0,0,0, 1,1,1,1,1, 1,0,0,0,0, 1,0,0,0,0],
            "Letra G": [0,1,1,1,1, 1,0,0,0,0, 1,0,1,1,1, 1,0,0,0,1, 0,1,1,1,0],
            "Letra H": [1,0,0,0,1, 1,0,0,0,1, 1,1,1,1,1, 1,0,0,0,1, 1,0,0,0,1],
            "Letra J": [0,0,0,0,1, 0,0,0,0,1, 0,0,0,0,1, 1,0,0,0,1, 0,1,1,1,0],
            "Letra K": [1,0,0,1,0, 1,0,1,0,0, 1,1,0,0,0, 1,0,1,0,0, 1,0,0,1,0],
            "Letra L": [1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,0,0,0,0, 1,1,1,1,1],
            "Letra M": [1,0,0,0,1, 1,1,0,1,1, 1,0,1,0,1, 1,0,0,0,1, 1,0,0,0,1],
            "Letra N": [1,0,0,0,1, 1,1,0,0,1, 1,0,1,0,1, 1,0,0,1,1, 1,0,0,0,1],
            "Letra P": [1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1, 1,0,0,0,0, 1,0,0,0,0],
            "Letra Q": [1,1,1,1,1, 1,0,0,0,1, 1,0,0,0,1, 1,0,0,1,0, 1,1,1,0,1],
            "Letra R": [1,1,1,1,0, 1,0,0,0,1, 1,1,1,1,0, 1,0,1,0,0, 1,0,0,1,0],
            "Letra S": [1,1,1,1,1, 1,0,0,0,0, 1,1,1,1,1, 0,0,0,0,1, 1,1,1,1,1],
            "Letra T": [1,1,1,1,1, 0,0,1,0,0, 0,0,1,0,0, 0,0,1,0,0, 0,0,1,0,0],
            "Letra U": [1,0,0,0,1, 1,0,0,0,1, 1,0,0,0,1, 1,0,0,0,1, 1,1,1,1,1],
            "Letra V": [1,0,0,0,1, 1,0,0,0,1, 0,1,0,1,0, 0,1,0,1,0, 0,0,1,0,0],
            "Letra W": [1,0,0,0,1, 1,0,0,0,1, 1,0,1,0,1, 1,1,0,1,1, 1,0,0,0,1],
            "Letra Y": [1,0,0,0,1, 0,1,0,1,0, 0,0,1,0,0, 0,0,1,0,0, 0,0,1,0,0],
            "Letra Z": [1,1,1,1,1, 0,0,0,1,0, 0,0,1,0,0, 0,1,0,0,0, 1,1,1,1,1],
            "Diamante": [0,0,1,0,0, 0,1,0,1,0, 1,0,1,0,1, 0,1,0,1,0, 0,0,1,0,0],
            "Pir√°mide": [0,0,1,0,0, 0,1,1,1,0, 1,1,1,1,1, 0,0,0,0,0, 0,0,0,0,0],
            "Flecha Abajo": [0,0,1,0,0, 0,0,1,0,0, 1,0,1,0,1, 0,1,1,1,0, 0,0,1,0,0],
            "Ajedrez": [1,0,1,0,1, 0,1,0,1,0, 1,0,1,0,1, 0,1,0,1,0, 1,0,1,0,1],
            "Cuatro Estampillas": [1,1,0,1,1, 1,1,0,1,1, 0,0,0,0,0, 1,1,0,1,1, 1,1,0,1,1],
            "Reloj de Arena": [1,1,1,1,1, 0,1,0,1,0, 0,0,1,0,0, 0,1,0,1,0, 1,1,1,1,1],
            "Mo√±o": [1,1,0,1,1, 1,1,0,1,1, 0,0,1,0,0, 1,1,0,1,1, 1,1,0,1,1],
            "Copa": [1,1,1,1,1, 0,1,1,1,0, 0,0,1,0,0, 0,0,1,0,0, 1,1,1,1,1],
            "Bander√≠n": [1,1,1,1,1, 1,1,1,1,0, 1,1,1,0,0, 1,1,0,0,0, 1,0,0,0,0],
            "Candelabro": [1,0,1,0,1, 1,0,1,0,1, 0,1,1,1,0, 0,0,1,0,0, 0,1,1,1,0],
            "Matamoscas": [1,1,1,1,1, 1,1,1,1,1, 1,1,1,1,1, 0,0,1,0,0, 0,0,1,0,0],
            "Monta√±a Rusa": [0,0,1,0,0, 0,1,0,1,0, 1,0,0,0,1, 1,0,0,0,1, 1,1,1,1,1],
            "Mariposa": [1,1,0,1,1, 1,1,0,1,1, 0,0,1,0,0, 1,1,0,1,1, 1,1,0,1,1],
            "Explosi√≥n": [0,0,1,0,0, 1,0,1,0,1, 0,1,1,1,0, 1,0,1,0,1, 0,0,1,0,0],
            "Marco Roto": [1,1,0,1,1, 1,0,0,0,1, 0,0,0,0,0, 1,0,0,0,1, 1,1,0,1,1],
            "Hueso": [0,1,1,1,0, 1,0,0,0,1, 0,0,1,0,0, 1,0,0,0,1, 0,1,1,1,0],
            "Avi√≥n": [0,0,1,0,0, 1,1,1,1,1, 0,0,1,0,0, 0,1,0,1,0, 0,1,0,1,0],
            "Hacha": [0,1,1,0,0, 1,1,1,0,0, 0,1,1,0,0, 0,0,1,0,0, 0,0,1,0,0],
            "Paraguas": [0,1,1,1,0, 1,1,1,1,1, 0,0,1,0,0, 1,0,1,0,0, 0,1,0,0,0],
            "Escalera": [1,0,0,0,1, 1,1,1,1,1, 1,0,0,0,1, 1,1,1,1,1, 1,0,0,0,1],
            "Cesta": [0,0,0,0,0, 1,0,0,0,1, 1,0,0,0,1, 1,1,1,1,1, 0,1,1,1,0],
            "Diana": [1,1,1,1,1, 1,0,0,0,1, 1,0,1,0,1, 1,0,0,0,1, 1,1,1,1,1],
            "Flecha de Cupido": [0,0,0,0,1, 0,0,0,1,0, 0,0,1,0,0, 1,1,0,0,0, 1,0,0,0,0],
            "Cascada": [1,0,0,0,0, 1,1,0,0,0, 1,1,1,0,0, 1,1,1,1,0, 1,1,1,1,1],
            "Cometa": [0,0,1,0,0, 0,1,1,1,0, 0,0,1,0,0, 0,0,1,0,0, 0,1,0,1,0],
            "Tablero": [0,1,0,1,0, 1,0,1,0,1, 0,1,0,1,0, 1,0,1,0,1, 0,1,0,1,0],
            "Ara√±a": [1,0,1,0,1, 0,1,1,1,0, 0,0,1,0,0, 0,1,1,1,0, 1,0,1,0,1],
            "Champ√°n": [1,1,1,1,1, 0,1,1,1,0, 0,0,1,0,0, 0,0,1,0,0, 0,1,1,1,0],
            "Doble C": [1,1,1,0,0, 1,0,0,0,0, 1,1,0,1,1, 0,0,1,0,0, 0,0,1,1,1],
            "Ancla": [1,0,1,0,1, 0,0,1,0,0, 0,0,1,0,0, 1,0,1,0,1, 0,1,1,1,0],
            "Ahorcado": [1,1,1,1,0, 1,0,0,1,0, 1,0,1,1,1, 1,0,0,1,0, 1,0,1,0,1],
        };

        let calledBalls = [];
        let lastBall = null;
        let autoTimer = null;
        let isAuto = false;
        let currentPatternKey = "L√≠nea Horizontal 1";

        document.addEventListener('DOMContentLoaded', () => {
            initBoard();
            populatePatternSelect(); 
            changePattern(); 
            resetDisplay();
        });

        // 1. DIBUJAR TABLERO
        function initBoard() {
            const table = document.getElementById('boardTable');
            table.innerHTML = '';

            letters.forEach(L => {
                const row = document.createElement('div');
                row.className = 'board-row';
                const letterBox = document.createElement('div');
                letterBox.className = `letter-box lb-${L}`;
                letterBox.innerText = L;
                row.appendChild(letterBox);
                for(let i=ranges[L].min; i<=ranges[L].max; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'num-cell';
                    cell.id = `cell-${i}`;
                    cell.innerText = i;
                    // AGREGADO: CLICK MANUAL
                    cell.setAttribute('onclick', 'toggleManual(this)');
                    row.appendChild(cell);
                }
                table.appendChild(row);
            });
        }

        // --- FUNCI√ìN PARA MARCAR/DESMARCAR MANUALMENTE ---
        function toggleManual(el) {
            const num = parseInt(el.innerText);

            // Si ya est√° marcado (rojo, verde o amarillo), lo desmarcamos
            if (el.classList.contains('called') || el.classList.contains('last') || el.classList.contains('winner')) {
                // Limpiar clases
                el.classList.remove('called', 'last', 'winner');
                el.style.background = '';
                el.style.color = '';
                
                // Quitar del array
                calledBalls = calledBalls.filter(n => n !== num);
                
                // Si era el √∫ltimo, regresamos al anterior en el array
                if (lastBall === num) {
                    lastBall = calledBalls.length > 0 ? calledBalls[calledBalls.length - 1] : null;
                    if(lastBall) {
                        // El anterior vuelve a ser verde (last)
                        const prevEl = document.getElementById(`cell-${lastBall}`);
                        if(prevEl) {
                            prevEl.classList.remove('called');
                            prevEl.classList.add('last');
                            prevEl.style.background = ''; 
                            prevEl.style.color = '';
                        }
                        updateDisplay(lastBall);
                    } else {
                        resetDisplay();
                    }
                }
                document.getElementById('txtCounter').innerText = `${calledBalls.length} de 75`;
                
            } else {
                // Si NO est√° marcado, lo marcamos como el ACTUAL (Verde + Balota)
                
                // 1. El anterior "last" pasa a "called" (Rojo)
                if(lastBall) {
                    const prev = document.getElementById(`cell-${lastBall}`);
                    if(prev) {
                        prev.classList.remove('last', 'winner');
                        prev.classList.add('called');
                        prev.style.background = ''; 
                        prev.style.color = '';
                    }
                }

                // 2. Este nuevo es "last" (Verde)
                el.classList.add('last');
                
                if(!calledBalls.includes(num)) {
                    calledBalls.push(num);
                }
                lastBall = num;
                
                // 3. Actualizar la bola grande y el historial
                updateDisplay(num);
                
                // --- NUEVO: VERIFICAR BINGO INMEDIATAMENTE AL MARCAR MANUALMENTE ---
                checkBingoWinner();
            }
        }

        function populatePatternSelect() {
            // Populate BOTH selects (Modal and Main Panel)
            const selectModal = document.getElementById('cfgPatternSelect');
            const selectMain = document.getElementById('cfgPatternSelectMain');
            
            [selectModal, selectMain].forEach(select => {
                if(!select) return;
                select.innerHTML = '';
                for (const key in patternsDB) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.text = key;
                    if(key === currentPatternKey) option.selected = true;
                    select.appendChild(option);
                }
            });
        }

        function changePattern() {
            // Get value from whichever select triggered it, or default to main
            const selectMain = document.getElementById('cfgPatternSelectMain');
            // If main select isn't available (e.g. if we remove it later), fallback to currentPatternKey
            const patternName = selectMain ? selectMain.value : currentPatternKey;
            
            currentPatternKey = patternName;
            const patternData = patternsDB[patternName];

            document.getElementById('lblFig').innerText = patternName;
            
            // Sync the other select just in case
            const selectModal = document.getElementById('cfgPatternSelect');
            if(selectModal) selectModal.value = patternName;
            // Sync main select in case change came from somewhere else
            if(selectMain) selectMain.value = patternName;

            const grid = document.getElementById('samplePatternGrid');
            grid.innerHTML = '';

            // INTENTAR CARGAR UN CART√ìN REAL (PRIMERO VENDIDO)
            let sampleNumbers = null;
            if (todosLosDatos) {
                // Buscar el primer cart√≥n vendido que tenga n√∫meros
                for (const key in todosLosDatos) {
                    if (todosLosDatos[key].estado === 'vendido' && todosLosDatos[key].numeros) {
                        sampleNumbers = todosLosDatos[key].numeros;
                        // Si es string, convertir a array
                        if (typeof sampleNumbers === 'string') sampleNumbers = sampleNumbers.split(',');
                        break;
                    }
                }
            }

            // Si no hay cart√≥n real, usar uno aleatorio v√°lido BINGO 75
            if (!sampleNumbers) {
                sampleNumbers = new Array(25).fill(0);
                 for (let col=0; col<5; col++) {
                     let min = (col * 15) + 1;
                     let max = (col + 1) * 15;
                     let used = [];
                     for (let row=0; row<5; row++) {
                         let n;
                         do { n = Math.floor(Math.random() * (max - min + 1)) + min; } while(used.includes(n));
                         used.push(n);
                         sampleNumbers[row * 5 + col] = n;
                     }
                 }
            }

            for(let i=0; i<25; i++) {
                const cell = document.createElement('div');
                cell.className = 'sample-cell';
                if(i===12) { 
                    cell.classList.add('center-free'); 
                    cell.innerText = 'FREE';
                } else {
                    if(patternData[i] === 1) cell.classList.add('active-pattern');
                    cell.innerText = sampleNumbers[i];
                }
                grid.appendChild(cell);
            }
        }

        function drawBall() {
            if(calledBalls.length >= 75) return;
            let num; do { num = Math.floor(Math.random() * 75) + 1; } while(calledBalls.includes(num));

            if(lastBall) {
                const prev = document.getElementById(`cell-${lastBall}`);
                prev.classList.remove('last', 'winner');
                prev.classList.add('called'); 
                prev.style.background = '';
                prev.style.color = '';
            }
            calledBalls.push(num);
            lastBall = num;
            const curr = document.getElementById(`cell-${num}`);
            curr.classList.add('last'); 

            updateDisplay(num);
            checkBingoWinner(); // VERIFICACI√ìN AUTOM√ÅTICA
        }

        function getLetterFromNumber(num) {
            if (num <= 15) return 'B';
            if (num <= 30) return 'I';
            if (num <= 45) return 'N';
            if (num <= 60) return 'G';
            return 'O';
        }

        function updateDisplay(num) {
            let L = getLetterFromNumber(num);
            let colorVar = ranges[L].color;
            if(L==='O') colorVar = '#fbc02d';

            const ballInner = document.getElementById('ballInner');
            ballInner.style.background = `radial-gradient(circle at 30% 30%, ${colorVar}, ${darkenColor(colorVar, 30)})`;
            ballInner.querySelector('.ball-letter').innerText = L;
            ballInner.querySelector('.ball-letter').style.color = getContrastColor(colorVar);
            ballInner.querySelector('.ball-number').innerText = num;
            ballInner.querySelector('.ball-number').style.color = getContrastColor(colorVar);
            
            const ball3D = document.getElementById('ball3D');
            ball3D.classList.remove('floating');
            void ball3D.offsetWidth;
            ball3D.classList.add('floating');

            document.getElementById('txtCounter').innerText = `${calledBalls.length} de 75`;

            const histContainer = document.getElementById('miniHistory');
            histContainer.innerHTML = '';
            const last4 = calledBalls.slice(-5, -1).reverse();
            
            for(let i=0; i<4; i++) {
                const d = document.createElement('div');
                d.className = 'mini-ball';
                if(last4[i]) {
                    let letL = getLetterFromNumber(last4[i]);
                    let c = ranges[letL].color;
                    d.innerText = last4[i];
                    d.style.background = `radial-gradient(circle at 30% 30%, ${c}, ${darkenColor(c, 30)})`;
                    d.style.color = getContrastColor(c);
                } else {
                    d.innerText = '-';
                    d.style.background = 'radial-gradient(circle at 30% 30%, #adb5bd, #7a8288)';
                    d.style.color = 'white';
                }
                histContainer.appendChild(d);
            }
        }

        function toggleBingoAnim() {
            if(isAuto) toggleAuto();
            if(!lastBall) return;
            const cell = document.getElementById(`cell-${lastBall}`);
            if(cell.classList.contains('winner')) { 
                cell.classList.remove('winner'); 
                cell.classList.add('last'); 
            } else { 
                cell.classList.remove('last'); 
                cell.classList.add('winner'); 
            }
        }

        function resetGame() {
            if(confirm("¬øReiniciar juego?")) {
                if(isAuto) toggleAuto();
                calledBalls = []; lastBall = null;
                document.querySelectorAll('.num-cell').forEach(c => { 
                    c.className = 'num-cell'; 
                    c.style.background=''; 
                    c.style.color=''; 
                    c.classList.remove('called', 'last', 'winner');
                });
                resetDisplay();
            }
        }

        function resetDisplay() {
            const ballInner = document.getElementById('ballInner');
            ballInner.style.background = `radial-gradient(circle at 30% 30%, var(--primary-green), #0d3b23)`;
            ballInner.querySelector('.ball-letter').innerText = 'GO';
            ballInner.querySelector('.ball-letter').style.color = 'white';
            ballInner.querySelector('.ball-number').innerText = '--';
            ballInner.querySelector('.ball-number').style.color = 'white';
            
            document.getElementById('miniHistory').innerHTML = '<div class="mini-ball">-</div><div class="mini-ball">-</div><div class="mini-ball">-</div><div class="mini-ball">-</div>';
            document.getElementById('txtCounter').innerText = '0 de 75';
        }

        function setMode(mode) {
            const autoBox = document.getElementById('autoControls');
            const btnD = document.getElementById('btnDraw');
            if(mode === 'auto') { autoBox.style.display = 'block'; btnD.disabled = true; btnD.style.opacity = '0.5'; }
            else { if(isAuto) toggleAuto(); autoBox.style.display = 'none'; btnD.disabled = false; btnD.style.opacity = '1'; }
        }

        function toggleAuto() {
            const btn = document.getElementById('btnAutoToggle');
            if(!isAuto) {
                let t = document.getElementById('autoTime').value;
                if(t<4) t=4;
                isAuto = true;
                btn.innerText = "Stop";
                btn.style.background = "#dc3545";
                btn.style.color = "white";
                drawBall();
                autoTimer = setInterval(drawBall, t*1000);
            } else {
                isAuto = false;
                clearInterval(autoTimer);
                btn.innerText = "Start";
                btn.style.background = "#e9ecef";
                btn.style.color = "black";
            }
        }

        function toggleConfig() { document.getElementById('configPanel').classList.toggle('active'); }
        function updateUI() {
            const logo = document.getElementById('cfgLogo').value;
            if(logo) document.getElementById('mainLogo').src = logo;
            document.getElementById('lblPrize').innerText = document.getElementById('cfgPrizeInput').value;
        }
        function updateColors() {
            document.documentElement.style.setProperty('--primary-green', document.getElementById('colPrim').value);
            document.documentElement.style.setProperty('--bg-color', document.getElementById('colBg').value);
        }

        // FULLSCREEN
        function toggleFullscreen() {
            const elem = document.getElementById('bingoContainer');
            if (!document.fullscreenElement) {
                if(elem.requestFullscreen) elem.requestFullscreen();
            } else {
                if(document.exitFullscreen) document.exitFullscreen();
            }
        }

        // UPDATE GAME PRIZE DISPLAY AND PATTERN
        function updateGamePrizeDisplay() {
            const select = document.getElementById('gamePrizeSelect');
            if(select.selectedIndex === -1) return;
            const selectedKey = select.value;
            const selectedText = select.options[select.selectedIndex].text;
            
            // 1. Update Labels
            if(valoresPremios && valoresPremios[selectedKey]) {
                document.getElementById('lblPrize').innerText = valoresPremios[selectedKey];
            }
            document.getElementById('lblTandaActiva').innerText = selectedText;

            // 2. Logic for Pattern Mapping
            let newPattern = "L√≠nea Horizontal 1"; 
            if (selectedKey === 't1') newPattern = "L√≠nea Horizontal 1";
            else if (selectedKey === 't2') newPattern = "L√≠nea Horizontal 2";
            else if (selectedKey === 't3') newPattern = "L√≠nea Horizontal 3"; 
            else if (selectedKey === 't4') newPattern = "Cart√≥n Lleno";

            // 3. Force Update Pattern Variable
            currentPatternKey = newPattern;
            
            // 4. Sync UI Pattern Selects
            const selectMain = document.getElementById('cfgPatternSelectMain');
            const selectModal = document.getElementById('cfgPatternSelect');
            if(selectMain) selectMain.value = newPattern;
            if(selectModal) selectModal.value = newPattern;
            
            // 5. Update Figure Display Text
            document.getElementById('lblFig').innerText = newPattern;

            // 6. Update Sample Grid manually (changePattern reads from select, which might be slow to update DOM)
            const grid = document.getElementById('samplePatternGrid');
            grid.innerHTML = '';
            
            const patternData = patternsDB[newPattern];
            
            // Re-fetch sample numbers logic (copied for safety to avoid glitches)
            let sampleNumbers = null;
            if (todosLosDatos) {
                for (const key in todosLosDatos) {
                    if (todosLosDatos[key].estado === 'vendido' && todosLosDatos[key].numeros) {
                        sampleNumbers = todosLosDatos[key].numeros;
                        if (typeof sampleNumbers === 'string') sampleNumbers = sampleNumbers.split(',');
                        break;
                    }
                }
            }
            if (!sampleNumbers) {
                sampleNumbers = new Array(25).fill(0);
                 for (let col=0; col<5; col++) {
                     let min = (col * 15) + 1; let max = (col + 1) * 15; let used = [];
                     for (let row=0; row<5; row++) {
                         let n; do { n = Math.floor(Math.random() * (max - min + 1)) + min; } while(used.includes(n)); used.push(n);
                         sampleNumbers[row * 5 + col] = n;
                     }
                 }
            }

            for(let i=0; i<25; i++) {
                const cell = document.createElement('div');
                cell.className = 'sample-cell';
                if(i===12) { 
                    cell.classList.add('center-free'); 
                    cell.innerText = 'FREE';
                } else {
                    if(patternData && patternData[i] === 1) cell.classList.add('active-pattern');
                    cell.innerText = sampleNumbers[i];
                }
                grid.appendChild(cell);
            }
        }

        // TOGGLE NUMBERS MODAL
        function toggleNumbersModal() {
            const modal = document.getElementById('numbersModal');
            if(modal.style.display === 'flex') {
                modal.style.display = 'none';
            } else {
                renderHistoryGrid();
                modal.style.display = 'flex';
            }
        }

        // RENDER HISTORY GRID
        function renderHistoryGrid() {
            const grid = document.getElementById('numbersGridHistory');
            grid.innerHTML = '';
            
            calledBalls.forEach((num, index) => {
                const el = document.createElement('div');
                const L = getLetterFromNumber(num);
                el.className = `hist-ball ball-${L}`;
                el.innerText = `${L}${num}`;
                el.title = `Bola #${index + 1}`;
                grid.appendChild(el);
            });
            
            if(calledBalls.length === 0) {
                grid.innerHTML = '<p class="text-center text-muted w-100">A√∫n no han salido n√∫meros.</p>';
            }
        }

        // --- FUNCIONES PARA EL MODAL DE SELECCI√ìN DE FIGURAS ---
        function openPatternModal() {
            const modal = document.getElementById('patternSelectionModal');
            renderPatternsInModal();
            modal.style.display = 'flex';
        }

        function renderPatternsInModal() {
            const gridContainer = document.getElementById('patternsGrid');
            gridContainer.innerHTML = '';

            for (const key in patternsDB) {
                const pattern = patternsDB[key];
                
                // Create Card
                const card = document.createElement('div');
                card.className = `pattern-item ${key === currentPatternKey ? 'active' : ''}`;
                card.onclick = () => selectPattern(key);

                // Title
                const title = document.createElement('div');
                title.className = 'pattern-name';
                title.innerText = key;
                card.appendChild(title);

                // Mini Grid
                const miniGrid = document.createElement('div');
                miniGrid.className = 'mini-pattern-grid';
                
                for(let i=0; i<25; i++) {
                    const cell = document.createElement('div');
                    cell.className = 'mini-pattern-cell';
                    if(i === 12) cell.className += ' free';
                    if(pattern[i] === 1) cell.className += ' active';
                    miniGrid.appendChild(cell);
                }
                card.appendChild(miniGrid);
                gridContainer.appendChild(card);
            }
        }

        function selectPattern(patternName) {
            const selectMain = document.getElementById('cfgPatternSelectMain');
            if(selectMain) selectMain.value = patternName;
            changePattern(); // Update main display logic
            document.getElementById('patternSelectionModal').style.display = 'none';
        }

        function selectRandomPattern() {
            const keys = Object.keys(patternsDB);
            const randomKey = keys[Math.floor(Math.random() * keys.length)];
            selectPattern(randomKey);
        }

        // CHECK BINGO AUTOMATICALLY - VERSI√ìN CORREGIDA
        function checkBingoWinner() {
            if (calledBalls.length < 4) return;
            if (!currentPatternKey || !patternsDB[currentPatternKey]) return;

            const pattern = patternsDB[currentPatternKey];
            const calledSet = new Set(calledBalls.map(n => parseInt(n, 10)));
            const winners = [];
            let hasNumerosField = false;

            Object.keys(todosLosDatos).forEach(key => {
                const carton = todosLosDatos[key];
                
                if (carton.estado === 'vendido') {
                    // PRIMERO: Verificar si existe propiedad 'numeros'
                    let numerosCarton = carton.numeros;
                    
                    if (!numerosCarton) {
                        console.warn(`Cart√≥n ${key} no tiene propiedad 'numeros'`);
                        return; // Saltar este cart√≥n
                    }
                    
                    hasNumerosField = true;
                    
                    // Convertir a array si es string
                    if (typeof numerosCarton === 'string') {
                        numerosCarton = numerosCarton.split(',').map(n => parseInt(n.trim(), 10));
                    }
                    
                    // Asegurar que sea array y tenga 25 elementos
                    if (!Array.isArray(numerosCarton) || numerosCarton.length !== 25) {
                        console.warn(`Cart√≥n ${key} no tiene 25 n√∫meros`);
                        return;
                    }
                    
                    let isWinner = true;
                    
                    // VERIFICAR EL PATR√ìN
                    for (let i = 0; i < 25; i++) {
                        if (pattern[i] === 1) { // Celda que debe estar marcada
                            // El centro (posici√≥n 12) es siempre libre
                            if (i === 12) continue;
                            
                            const num = numerosCarton[i];
                            
                            // Validar que el n√∫mero exista y est√© marcado
                            if (num === undefined || num === null || num === 0) {
                                isWinner = false;
                                break;
                            }
                            
                            if (!calledSet.has(parseInt(num, 10))) {
                                isWinner = false;
                                break;
                            }
                        }
                    }
                    
                    if (isWinner) {
                        winners.push({
                            id: key,
                            nombre: carton.nombre || 'Sin nombre',
                            telefono: carton.telefono || 'Sin tel√©fono'
                        });
                    }
                }
            });
            
            // ADVERTENCIA si no hay cartones con n√∫meros
            if (!hasNumerosField && calledBalls.length > 5 && !dataWarningShown) {
                alert("‚ö†Ô∏è ADVERTENCIA CR√çTICA:\n\nLos cartones vendidos NO tienen la propiedad 'numeros'.\n\nSOLUCI√ìN:\n1. Ve a la p√°gina de venta\n2. Aseg√∫rate que cada cart√≥n guarde un array de 25 n√∫meros\n3. Ejemplo: [5,12,0,0,18, 22,0,28,0,0, 0,0,0,0,42, 0,51,0,0,59, 61,0,0,70,0]\n(0 = espacio vac√≠o)");
                dataWarningShown = true;
            }
            
            // MOSTRAR GANADORES
            if (winners.length > 0) {
                if (isAuto) toggleAuto();
                
                // Sonido de victoria
                try {
                    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2019/2019-preview.mp3');
                    audio.play();
                } catch(e) {}
                
                // PREPARAR DATOS DE PREMIO Y SPLIT
                let totalPrizeStr = document.getElementById('lblPrize').textContent;
                let totalPrize = parseCurrency(totalPrizeStr);
                let prizeLabel = totalPrizeStr;

                // Si hay m√°s de un ganador, dividir el premio
                if (winners.length > 1) {
                    let individualPrize = totalPrize / winners.length;
                    prizeLabel = formatCurrency(individualPrize) + " (c/u)";
                }

                // --- NUEVO: MOSTRAR MODAL EN LUGAR DE ALERTA ---
                showWinnerModal(winners, currentPatternKey, prizeLabel);
                
                // Marcar visualmente las celdas ganadoras en el tablero
                highlightWinningNumbers(winners);
                
                // NO REGISTRAR AUTOM√ÅTICAMENTE (COMENTADO A PETICI√ìN)
                /*
                if (winners.length > 0) {
                    const primerGanador = winners[0];
                    // ... L√≥gica de registro autom√°tico ...
                }
                */
            } else {
                 // Feedback visual si no hay ganadores al pulsar el bot√≥n manualmente
                 if(calledBalls.length > 4) {
                     // Solo mostrar si no es autom√°tico, para no spammear
                     // O usar un toast discreto
                 }
            }
        }

        // Funci√≥n auxiliar para resaltar n√∫meros ganadores
        function highlightWinningNumbers(winners) {
            // Primero quitar cualquier resaltado anterior
            document.querySelectorAll('.num-cell.winner').forEach(cell => {
                cell.classList.remove('winner');
            });
            
            // Resaltar los n√∫meros del primer ganador
            if (winners.length > 0) {
                const primerGanador = todosLosDatos[winners[0].id];
                if (primerGanador && primerGanador.numeros) {
                    let numeros = primerGanador.numeros;
                    if (typeof numeros === 'string') {
                        numeros = numeros.split(',').map(n => parseInt(n.trim(), 10));
                    }
                    
                    numeros.forEach(num => {
                        if (num && num > 0) {
                            const cell = document.getElementById(`cell-${num}`);
                            if (cell) {
                                cell.classList.add('winner');
                            }
                        }
                    });
                }
            }
        }

        // FUNCI√ìN DE PRUEBA - Crear cartones de ejemplo con n√∫meros
        window.crearCartonesEjemplo = function() {
            // Crear 5 cartones de ejemplo con n√∫meros BINGO v√°lidos
            const cartonesEjemplo = {};
            
            for (let c = 1; c <= 5; c++) {
                const numeros = [];
                
                // Generar n√∫meros v√°lidos para cada columna B-I-N-G-O
                for (let col = 0; col < 5; col++) {
                    const min = (col * 15) + 1;
                    const max = (col + 1) * 15;
                    const columna = [];
                    
                    // 5 n√∫meros √∫nicos por columna
                    while (columna.length < 5) {
                        const num = Math.floor(Math.random() * (max - min + 1)) + min;
                        if (!columna.includes(num)) {
                            columna.push(num);
                        }
                    }
                    
                    // A√±adir a la matriz en orden de filas
                    for (let row = 0; row < 5; row++) {
                        numeros[row * 5 + col] = columna[row];
                    }
                }
                
                // Hacer el centro (posici√≥n 12) = 0 (espacio libre)
                numeros[12] = 0;
                
                cartonesEjemplo[c] = {
                    estado: 'vendido',
                    nombre: `Cliente Ejemplo ${c}`,
                    telefono: `0412-555000${c}`,
                    referencia: `REF-EJ${c}`,
                    numeros: numeros, // ARRAY DE 25 N√öMEROS
                    verificado: true,
                    fecha: new Date().toISOString()
                };
            }
            
            // Guardar en Firebase
            cartonesRef.update(cartonesEjemplo).then(() => {
                alert('‚úÖ 5 cartones de ejemplo creados con n√∫meros BINGO v√°lidos.\nAhora puedes probar el sistema de detecci√≥n.');
            });
        }

        // Funci√≥n de diagn√≥stico
        window.diagnosticarCartones = function() {
            console.log("=== DIAGN√ìSTICO DE CARTONES ===");
            
            Object.keys(todosLosDatos).forEach(key => {
                const carton = todosLosDatos[key];
                if (carton.estado === 'vendido') {
                    console.log(`Cart√≥n ${key}:`);
                    console.log(`- Tiene propiedad 'numeros': ${carton.numeros ? 'S√ç' : 'NO'}`);
                    if (carton.numeros) {
                        console.log(`- Tipo: ${typeof carton.numeros}`);
                        if (Array.isArray(carton.numeros)) {
                            console.log(`- Longitud: ${carton.numeros.length}`);
                            console.log(`- N√∫meros: ${carton.numeros.slice(0, 5)}...`);
                        }
                    }
                }
            });
        }
        
        // --- FUNCIONES OCR Y EDICI√ìN DE CARTONES ---
        function toggleEditModal() {
            const modal = document.getElementById('editCardModal');
            modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
        }
        
        function loadCardForEdit() {
            const id = document.getElementById('editCardId').value;
            if(!id || !todosLosDatos[id]) { alert("Cart√≥n no encontrado"); return; }
            
            const card = todosLosDatos[id];
            
            // 1. Cargar Imagen
            const img = document.getElementById('editCardImage');
            img.src = `cartones/${id}.jpg`; // Intentar cargar ruta local
            
            // 2. Cargar N√∫meros
            const grid = document.getElementById('editGridContainer');
            grid.innerHTML = '';
            
            let nums = card.numeros || new Array(25).fill(0);
            if(typeof nums === 'string') nums = nums.split(',');
            
            for(let i=0; i<25; i++) {
                const input = document.createElement('input');
                input.type = 'number';
                input.id = `edit-cell-${i}`;
                if(i===12) { 
                    input.value = 0; 
                    input.disabled = true; 
                    input.style.backgroundColor = '#ccc';
                } else {
                    input.value = nums[i] || '';
                }
                grid.appendChild(input);
            }
        }
        
        function previewLocalImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    document.getElementById('editCardImage').src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }
        
        // OCR INTELLIGENT PARSER
        async function autoDetectNumbers() {
            const imgElement = document.getElementById('editCardImage');
            const btn = document.querySelector('.btn-info'); // Bot√≥n OCR
            const originalText = btn.innerHTML;
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Leyendo...';
            btn.disabled = true;
            
            try {
                // Tesseract.js worker
                const worker = await Tesseract.createWorker('eng'); // 'eng' suele leer mejor d√≠gitos que 'spa'
                
                // Reconocer imagen
                const ret = await worker.recognize(imgElement);
                console.log(ret.data.text);
                
                // Extraer todos los n√∫meros encontrados
                const foundNumbers = ret.data.text.match(/\d+/g);
                
                if(foundNumbers && foundNumbers.length >= 24) {
                    // Intentar llenar el grid
                    // Nota: Esto es experimental. Los OCR leen de izq a derecha, arriba a abajo.
                    // Asumiremos que lee fila por fila.
                    
                    let numIndex = 0;
                    for(let i=0; i<25; i++) {
                        if(i === 12) continue; // Saltar centro
                        
                        // Filtrar n√∫meros muy grandes o muy peque√±os si es necesario (1-75)
                        // Aqu√≠ tomamos los primeros 24 n√∫meros que parezcan v√°lidos
                        if(numIndex < foundNumbers.length) {
                             document.getElementById(`edit-cell-${i}`).value = foundNumbers[numIndex];
                             numIndex++;
                        }
                    }
                    alert("Lectura completada. Por favor VERIFICA los n√∫meros.");
                } else {
                    alert("No se detectaron suficientes n√∫meros. Intenta subir una imagen m√°s clara.");
                }
                
                await worker.terminate();
                
            } catch (err) {
                console.error(err);
                alert("Error en OCR: " + err);
            }
            
            btn.innerHTML = originalText;
            btn.disabled = false;
        }

        function saveCardNumbers() {
            const id = document.getElementById('editCardId').value;
            if(!id) return;
            
            const newNumbers = [];
            for(let i=0; i<25; i++) {
                const val = document.getElementById(`edit-cell-${i}`).value;
                newNumbers.push(parseInt(val) || 0);
            }
            
            cartonesRef.child(id).update({ numeros: newNumbers }).then(() => {
                alert("‚úÖ N√∫meros actualizados correctamente para el cart√≥n #" + id);
                toggleEditModal();
            });
        }

        // Helpers
        function darkenColor(color, percent) {
            let R = parseInt(color.substring(1,3),16);
            let G = parseInt(color.substring(3,5),16);
            let B = parseInt(color.substring(5,7),16);
            R = Math.floor(R * (100 - percent) / 100);
            G = Math.floor(G * (100 - percent) / 100);
            B = Math.floor(B * (100 - percent) / 100);
            return "#" + ((R << 16) | (G << 8) | B).toString(16).padStart(6, '0');
        }
        
        function getContrastColor(hexColor) {
            let r = parseInt(hexColor.substr(1, 2), 16);
            let g = parseInt(hexColor.substr(3, 2), 16);
            let b = parseInt(hexColor.substr(5, 2), 16);
            let luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
            return luminance > 0.5 ? '#000000' : '#FFFFFF';
        }

        // --- NUEVA FUNCI√ìN: MOSTRAR MODAL DE GANADOR ---
        function showWinnerModal(winners, patternName, prizeValue) {
            const modalContent = document.getElementById('winnerModalContent');
            document.getElementById('modalPatternName').textContent = patternName;
            document.getElementById('modalPrizeValue').textContent = prizeValue;
            
            modalContent.innerHTML = '';
            
            winners.forEach(w => {
                const cardHtml = `
                    <div class="card text-dark shadow-sm" style="width: 22rem;"> <div class="card-header bg-warning fw-bold fs-5">Cart√≥n #${w.id}</div>
                      <div class="position-relative">
                        <img src="cartones/${w.id}.jpg" class="card-img-top" alt="Cart√≥n ${w.id}" onerror="this.src='https://via.placeholder.com/300x200?text=Sin+Imagen'" style="height: 300px; object-fit: contain; background: #f8f9fa;"> </div>
                      <div class="card-body p-2">
                        <h5 class="card-title fw-bold mb-0 text-truncate">${w.nombre}</h5>
                        <p class="card-text text-muted small mb-0">${w.telefono}</p>
                      </div>
                    </div>
                `;
                modalContent.innerHTML += cardHtml;
            });
            
            const myModal = new bootstrap.Modal(document.getElementById('bingoWinnerModal'));
            myModal.show();
        }
    </script>
</body>
</html>