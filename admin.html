<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Calipso Bingo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: #1a5e3a !important; }
        .card-config { border-left: 5px solid #ffc107; }
        .card-winners { border-left: 5px solid #0d6efd; } 
        .btn-action { margin: 0 2px; }
        .row-verificado { background-color: #d1e7dd !important; }
        .badge-verificado { background-color: #198754; }
        .badge-pendiente { background-color: #ffc107; color: #000; }
        
        /* ESTILOS CALCULADORA */
        .prizes-panel { background-color: #2c3e50; color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .prize-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .prize-card.grand-prize { background: linear-gradient(135deg, #FF6B35, #e55a2b); border: none; transform: scale(1.05); box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4); }
        .prize-amount { font-size: 20px; font-weight: 800; display: block; margin-top: 5px; }
        .input-promedio { width: 80px; text-align: center; font-weight: bold; border-radius: 5px; border: none; padding: 2px; color: #333; }
        
        /* BARRA DE PROGRESO */
        .progress-container { margin-bottom: 20px; }
        .progress { height: 10px; border-radius: 5px; background-color: #e9ecef; }
        .progress-bar { background-color: #1a5e3a; transition: width 0.5s ease; }

        /* BUSCADOR TABLA */
        .search-panel { background: white; padding: 15px; border-bottom: 1px solid #eee; }

        /* Estilo para el toggle switch del modo mantenimiento */
        .maintenance-toggle-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff0f0; /* Fondo rojo claro para destacar */
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            border: 1px solid #ffcccc;
        }
        .maintenance-label {
            margin: 0;
            font-weight: bold;
            color: #d32f2f;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .switch {
          position: relative;
          display: inline-block;
          width: 50px;
          height: 24px;
        }
        .switch input { 
          opacity: 0;
          width: 0;
          height: 0;
        }
        .slider {
          position: absolute;
          cursor: pointer;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background-color: #ccc;
          -webkit-transition: .4s;
          transition: .4s;
        }
        .slider:before {
          position: absolute;
          content: "";
          height: 16px;
          width: 16px;
          left: 4px;
          bottom: 4px;
          background-color: white;
          -webkit-transition: .4s;
          transition: .4s;
        }
        input:checked + .slider {
          background-color: #d32f2f; /* Rojo cuando est√° activado */
        }
        input:focus + .slider {
          box-shadow: 0 0 1px #d32f2f;
        }
        input:checked + .slider:before {
          -webkit-transform: translateX(26px);
          -ms-transform: translateX(26px);
          transform: translateX(26px);
        }
        .slider.round {
          border-radius: 24px;
        }
        .slider.round:before {
          border-radius: 50%;
        }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-cogs"></i> Panel de Control</span>
            <div class="d-flex gap-2">
                <a href="index.html" class="btn btn-outline-light btn-sm" target="_blank">
                    <i class="fas fa-external-link-alt"></i> Ver Tienda
                </a>
                <a href="ganadores.html" class="btn btn-outline-warning btn-sm" target="_blank">
                    <i class="fas fa-trophy"></i> Ver Ganadores
                </a>
                <button class="btn btn-warning btn-sm fw-bold" onclick="window.location.href='index.html'">Salir</button>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div class="prizes-panel">
            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                <div>
                    <h5 class="m-0 fw-bold">üí∞ ESTRUCTURA DE PREMIOS (70%)</h5>
                    <small class="text-white-50">Tu Ganancia (30%): <span id="lblGanancia" class="fw-bold text-warning">Bs 0</span></small>
                </div>
                <div>
                    <small>Precio Promedio (Est.):</small>
                    <input type="number" id="inputPrecioPromedio" class="input-promedio" value="0" step="0.01" onchange="recalcularPremios()">
                </div>
            </div>
            <div class="row g-3">
                <div class="col-6 col-md-3"><div class="prize-card"><small class="text-uppercase text-white-50">1¬™ Tanda (10%)</small><span class="prize-amount" id="prizeT1">Bs 0</span></div></div>
                <div class="col-6 col-md-3"><div class="prize-card"><small class="text-uppercase text-white-50">2¬™ Tanda (10%)</small><span class="prize-amount" id="prizeT2">Bs 0</span></div></div>
                <div class="col-6 col-md-3"><div class="prize-card"><small class="text-uppercase text-white-50">3¬™ Tanda (15%)</small><span class="prize-amount" id="prizeT3">Bs 0</span></div></div>
                <div class="col-6 col-md-3"><div class="prize-card grand-prize"><small class="text-uppercase fw-bold">üëë CART√ìN LLENO (35%)</small><span class="prize-amount" id="prizeT4">Bs 0</span></div></div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 card-winners">
            <div class="card-header bg-primary text-white fw-bold d-flex justify-content-between align-items-center">
                <span><i class="fas fa-trophy"></i> REGISTRO DE GANADORES</span>
                <span class="badge bg-warning text-dark shadow-sm">
                    <i class="far fa-calendar-alt"></i> Sorteo: <span id="badgeFechaActiva">Cargando...</span>
                </span>
            </div>
            <div class="card-body">
                <p class="text-muted small mb-3">Los ganadores que registres aqu√≠ quedar√°n guardados bajo la fecha: <strong><span id="txtFechaConfirmacion">...</span></strong></p>
                
                <div class="row g-2 align-items-end mb-4 p-3 bg-light rounded border">
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">1. Selecciona Premio</label>
                        <select id="selectTipoPremio" class="form-select form-select-sm" onchange="actualizarMontoPremio()">
                            <option value="">-- Manual --</option>
                            <option value="t1">1¬™ Tanda (10%)</option>
                            <option value="t2">2¬™ Tanda (10%)</option>
                            <option value="t3">3¬™ Tanda (15%)</option>
                            <option value="t4">üëë CART√ìN LLENO (35%)</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label fw-bold small">2. N¬∫ Cart√≥n</label>
                        <input type="number" id="winCarton" class="form-control form-control-sm" placeholder="Ej: 154" onchange="buscarDue√±o()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Monto / Premio</label>
                        <input type="text" id="winPremio" class="form-control form-control-sm" placeholder="Se llena solo...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold small">Ganador (Cliente)</label>
                        <input type="text" id="winNombre" class="form-control form-control-sm" placeholder="Se busca solo..." readonly style="background-color: #e9ecef;">
                    </div>
                    <div class="col-md-1">
                        <button onclick="agregarGanador()" class="btn btn-success btn-sm w-100 fw-bold" title="Guardar Ganador"><i class="fas fa-plus"></i></button>
                    </div>
                </div>

                <div>
                    <h6 class="text-muted border-bottom pb-2">üìã Lista de Ganadores Publicada</h6>
                    <div class="table-responsive">
                        <table class="table table-striped table-bordered align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Fecha Sorteo</th>
                                    <th>Cart√≥n</th>
                                    <th>Premio</th>
                                    <th>Nombre del Ganador</th>
                                    <th style="width: 50px;">Borrar</th>
                                </tr>
                            </thead>
                            <tbody id="tableWinners">
                                </tbody>
                        </table>
                    </div>
                </div>

                <div class="mt-3 text-end">
                    <button class="btn btn-outline-danger btn-sm" onclick="resetearGanadores()">
                        <i class="fas fa-trash"></i> BORRAR TODOS LOS GANADORES
                    </button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 card-config">
            <div class="card-header bg-white fw-bold">
                <i class="fas fa-edit"></i> Configuraci√≥n del Sorteo
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-4"><label class="form-label">T√≠tulo del Evento</label><input type="text" id="confTitulo" class="form-control" placeholder="Cargando..."></div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-danger">Fecha Sorteo</label>
                        <input type="text" id="confFecha" class="form-control" placeholder="Ej: 8 de Enero 2026">
                    </div>

                    <div class="col-md-2">
                        <label class="form-label fw-bold text-danger">Hora Sorteo</label>
                        <input type="text" id="confHora" class="form-control" placeholder="Ej: 08:00 PM">
                    </div>

                    <div class="col-md-3"><label class="form-label fw-bold text-dark">üì¶ Total Cartones</label><input type="number" id="confTotalCartones" class="form-control" placeholder="Ej: 1000"></div>
                    
                    <div class="col-12 mt-3 mb-1">
                        <div class="form-check form-switch p-2 bg-light border rounded d-flex align-items-center">
                            <input class="form-check-input me-2" type="checkbox" id="toggleDescuentos" onchange="calcularPreciosAutomaticos()">
                            <label class="form-check-label fw-bold text-primary" for="toggleDescuentos">
                                ‚ú® Aplicar Descuentos Autom√°ticos (Si desactivas, cobra precio full)
                            </label>
                        </div>
                    </div>

                    <div class="col-md-3">
                        <label class="form-label fw-bold text-success">Precio Base (1)</label>
                        <input type="number" id="confPrecioBase" class="form-control" step="0.01" placeholder="Ej: 50">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-secondary">Paquete x 4</label>
                        <input type="number" id="confPromo4" class="form-control" step="0.01" readonly style="background-color: #e8f5e9;">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-secondary">Paquete x 8</label>
                        <input type="number" id="confPromo8" class="form-control" step="0.01" readonly style="background-color: #e8f5e9;">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-secondary">Paquete x 12</label>
                        <input type="number" id="confPromo12" class="form-control" step="0.01" readonly style="background-color: #e8f5e9;">
                    </div>
                    
                    <div class="col-12">
                        <div class="maintenance-toggle-container">
                            <label for="mantenimientoToggle" class="maintenance-label"><i class="fas fa-ban"></i> Modo Mantenimiento (Cerrar Sitio):</label>
                            <label class="switch">
                                <input type="checkbox" id="mantenimientoToggle">
                                <span class="slider round"></span>
                            </label>
                        </div>
                    </div>

                    <div class="col-12 text-end mt-3">
                        <button class="btn btn-success fw-bold px-4" onclick="guardarConfiguracion()"><i class="fas fa-save"></i> ACTUALIZAR DATOS</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-2">
            <div class="col-md-4"><div class="card bg-white p-3 shadow-sm text-center border-0 h-100"><h6 class="text-muted text-uppercase small">Total Vendidos</h6><h2 class="text-success fw-bold m-0" id="totalVendidos">0</h2><small class="fw-bold text-muted" id="lblPorcentaje" style="font-size: 14px;">0%</small></div></div>
            <div class="col-md-4"><div class="card bg-white p-3 shadow-sm text-center border-0 h-100"><h6 class="text-muted text-uppercase small">Recaudaci√≥n Total (Est.)</h6><h2 class="text-primary fw-bold" id="totalDinero">Bs 0,00</h2></div></div>
            <div class="col-md-4"><div class="card bg-white p-3 shadow-sm text-center border-0 h-100"><h6 class="text-muted text-uppercase small">Disponibles</h6><h2 class="text-secondary fw-bold" id="totalDisponibles">...</h2></div></div>
        </div>

        <div class="progress-container"><div class="progress"><div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%"></div></div></div>

        <div class="row mb-3">
            <div class="col-12 d-flex justify-content-between">
                <button class="btn btn-success fw-bold" onclick="descargarExcel()"><i class="fas fa-file-excel"></i> DESCARGAR LISTA SIMPLIFICADA</button>
                <button class="btn btn-outline-danger btn-sm" onclick="reiniciarVentas()"><i class="fas fa-trash-alt"></i> BORRAR VENTAS (RESET TOTAL)</button>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white fw-bold"><i class="fas fa-list"></i> Gesti√≥n de Ventas</div>
            
            <div class="search-panel">
                <div class="row g-2">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i class="fas fa-search text-muted"></i></span>
                            <input type="text" id="buscadorVentas" class="form-control border-start-0" placeholder="Buscar por cliente, tel√©fono, referencia o # cart√≥n..." onkeyup="filtrarTabla()">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select id="filtroEstado" class="form-select" onchange="filtrarTabla()">
                            <option value="todos">Todos los Estados</option>
                            <option value="pendientes">‚è≥ Solo Pendientes</option>
                            <option value="verificados">‚úÖ Solo Verificados</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light"><tr><th>Cart√≥n #</th><th>Cliente</th><th>Tel√©fono / Referencia</th><th>Estado</th><th class="text-end">Acciones</th></tr></thead>
                        <tbody id="tablaCuerpo"><tr><td colspan="5" class="text-center p-4 text-muted">Cargando datos...</td></tr></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        // CONTRASE√ëA OFUSCADA (admin123 en Base64)
        const pass = prompt("Ingrese contrase√±a de administrador:");
        if (btoa(pass) !== "YWRtaW4xMjM=") { window.location.href = "index.html"; }

        const firebaseConfig = {
            apiKey: "AIzaSyBtj_J5wQ4y-U3UDwwphud9Wir1n7WcI2s",
            authDomain: "calipsobingo-f532b.firebaseapp.com",
            databaseURL: "https://calipsobingo-f532b-default-rtdb.firebaseio.com",
            projectId: "calipsobingo-f532b",
            storageBucket: "calipsobingo-f532b.firebasestorage.app",
            messagingSenderId: "196074596826",
            appId: "1:196074596826:web:db6280789eb0d51ddd38e3",
            measurementId: "G-M9XK1H641N"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const cartonesRef = database.ref('cartones');
        const configRef = database.ref('configuracion');
        const resultadosRef = database.ref('resultados'); 

        let precioBaseActual = 50;
        let totalCartonesGlobal = 1000;
        let totalVendidosCount = 0;
        let todosLosDatos = {}; 
        let valoresPremios = { t1: "Bs 0", t2: "Bs 0", t3: "Bs 0", t4: "Bs 0" };
        let primeraCarga = true; 
        let totalVentasAnterior = 0;

        // --- C√ÅLCULO INTELIGENTE CON INTERRUPTOR ---
        function calcularPreciosAutomaticos() {
            const base = parseFloat(document.getElementById('confPrecioBase').value);
            const usarDescuentos = document.getElementById('toggleDescuentos').checked;

            if(!isNaN(base)) {
                if(usarDescuentos) {
                    // CON DESCUENTOS: 10%, 12.5%, 15%
                    document.getElementById('confPromo4').value = Math.round((base * 4) * 0.90);
                    document.getElementById('confPromo8').value = Math.round((base * 8) * 0.875);
                    document.getElementById('confPromo12').value = Math.round((base * 12) * 0.85);
                } else {
                    // SIN DESCUENTOS (Precio Full)
                    document.getElementById('confPromo4').value = base * 4;
                    document.getElementById('confPromo8').value = base * 8;
                    document.getElementById('confPromo12').value = base * 12;
                }

                // C√°lculo del Precio Promedio Unitario para la Calculadora
                const p4 = parseFloat(document.getElementById('confPromo4').value);
                const p8 = parseFloat(document.getElementById('confPromo8').value);
                const p12 = parseFloat(document.getElementById('confPromo12').value);
                
                // Promedio de los 4 escenarios (Unitario, y unitarios dentro de paquetes)
                const avgUnit = (base + (p4/4) + (p8/8) + (p12/12)) / 4;
                document.getElementById('inputPrecioPromedio').value = avgUnit.toFixed(2);
                
                recalcularPremios();
            }
        }

        // Event Listeners
        document.getElementById('confPrecioBase').addEventListener('input', calcularPreciosAutomaticos);

        function abrirWhatsApp(telefonoRaw, mensaje) {
            let telefono = telefonoRaw.replace(/\D/g, ''); 
            if (!telefono.startsWith('58')) telefono = '58' + telefono;
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
            let url = isMobile 
                ? `https://wa.me/${telefono}?text=${encodeURIComponent(mensaje)}`
                : `https://web.whatsapp.com/send?phone=${telefono}&text=${encodeURIComponent(mensaje)}`;
            window.open(url, '_blank');
        }

        resultadosRef.on('value', (snapshot) => {
            const data = snapshot.val() || {};
            const tbodyWin = document.getElementById('tableWinners');
            tbodyWin.innerHTML = '';
            
            if(data.ganadores) {
                Object.entries(data.ganadores).forEach(([key, g]) => {
                    const tr = `<tr>
                        <td class="small text-muted fw-bold">${g.fecha || '-'}</td>
                        <td class="fw-bold text-center fs-5">#${g.carton}</td>
                        <td>${g.premio}</td>
                        <td>${g.nombre}</td>
                        <td class="text-center"><button class="btn btn-sm btn-outline-danger" onclick="borrarGanador('${key}')"><i class="fas fa-trash"></i></button></td>
                    </tr>`;
                    tbodyWin.innerHTML += tr;
                });
            } else {
                tbodyWin.innerHTML = '<tr><td colspan="5" class="text-center text-muted small p-3">No hay ganadores registrados todav√≠a.</td></tr>';
            }
        });

        window.actualizarMontoPremio = function() {
            const seleccion = document.getElementById('selectTipoPremio').value;
            const inputPremio = document.getElementById('winPremio');
            if(seleccion && valoresPremios[seleccion]) {
                let etiqueta = "";
                if(seleccion === 't1') etiqueta = "1¬™ Tanda";
                if(seleccion === 't2') etiqueta = "2¬™ Tanda";
                if(seleccion === 't3') etiqueta = "3¬™ Tanda";
                if(seleccion === 't4') etiqueta = "CART√ìN LLENO";
                inputPremio.value = `${etiqueta} - ${valoresPremios[seleccion]}`;
            } else {
                inputPremio.value = "";
            }
        }

        window.buscarDue√±o = function() {
            const numeroCarton = document.getElementById('winCarton').value;
            const inputNombre = document.getElementById('winNombre');
            if(!numeroCarton) return;
            inputNombre.value = "Buscando...";
            inputNombre.style.backgroundColor = "#fff3cd"; 
            cartonesRef.child(numeroCarton).once('value').then((snapshot) => {
                const datos = snapshot.val();
                if(datos && datos.estado === 'vendido') {
                    inputNombre.value = datos.nombre || "Sin Nombre Registrado";
                    inputNombre.style.backgroundColor = "#d1e7dd"; 
                } else {
                    inputNombre.value = "‚ö†Ô∏è CART√ìN NO VENDIDO O LIBRE";
                    inputNombre.style.backgroundColor = "#f8d7da"; 
                }
            });
        }

        window.agregarGanador = function() {
            const c = document.getElementById('winCarton').value;
            const p = document.getElementById('winPremio').value;
            const n = document.getElementById('winNombre').value;
            const fechaMaestra = document.getElementById('confFecha').value;
            
            if (!fechaMaestra || fechaMaestra.trim() === "") {
                alert("‚õî ERROR: Debes escribir la 'Fecha Sorteo' en Configuraci√≥n antes de registrar ganadores.");
                document.getElementById('confFecha').focus();
                return;
            }
            
            if(c && p && n && !n.includes("NO VENDIDO")) {
                resultadosRef.child('ganadores').push({ carton: c, premio: p, nombre: n, fecha: fechaMaestra });
                document.getElementById('winCarton').value = '';
                document.getElementById('winPremio').value = '';
                document.getElementById('winNombre').value = '';
                document.getElementById('selectTipoPremio').value = '';
                document.getElementById('winNombre').style.backgroundColor = "#e9ecef";
            } else { alert("‚ö†Ô∏è Verifica los datos."); }
        }

        window.borrarGanador = function(key) { if(confirm('¬øEliminar ganador?')) resultadosRef.child('ganadores').child(key).remove(); }
        window.resetearGanadores = function() { if(confirm("‚ö†Ô∏è ¬øBorrar TODOS los ganadores?")) resultadosRef.child('ganadores').remove(); }
        
        configRef.on('value', (snapshot) => {
            const config = snapshot.val();
            if (config) {
                document.getElementById('confTitulo').value = config.titulo || '';
                const fechaCargada = config.fecha || '';
                document.getElementById('confFecha').value = fechaCargada;
                document.getElementById('confHora').value = config.hora || '';

                const badgeFecha = document.getElementById('badgeFechaActiva');
                const txtFechaConfirmacion = document.getElementById('txtFechaConfirmacion');
                
                if(fechaCargada) {
                    badgeFecha.textContent = fechaCargada;
                    txtFechaConfirmacion.textContent = fechaCargada;
                    badgeFecha.className = "badge bg-warning text-dark shadow-sm";
                } else {
                    badgeFecha.textContent = "SIN FECHA";
                    txtFechaConfirmacion.textContent = "SIN FECHA";
                    badgeFecha.className = "badge bg-danger text-white shadow-sm";
                }

                document.getElementById('confTotalCartones').value = config.totalCartones || 1000;
                document.getElementById('confPrecioBase').value = config.precioBase || 0;
                document.getElementById('confPromo4').value = config.promo4 || 0;
                document.getElementById('confPromo8').value = config.promo8 || 0;
                document.getElementById('confPromo12').value = config.promo12 || 0;
                
                // Cargar estado del switch de descuentos
                const usarDescuentos = config.usarDescuentos !== undefined ? config.usarDescuentos : true;
                document.getElementById('toggleDescuentos').checked = usarDescuentos;

                // NUEVO: Cargar estado del switch de mantenimiento
                const modoMantenimiento = config.modoMantenimiento !== undefined ? config.modoMantenimiento : false;
                document.getElementById('mantenimientoToggle').checked = modoMantenimiento;

                precioBaseActual = parseFloat(config.precioBase) || 0;
                totalCartonesGlobal = parseInt(config.totalCartones) || 1000;
                
                // Calcular promedio inicial
                const p4 = parseFloat(config.promo4) || 0;
                const p8 = parseFloat(config.promo8) || 0;
                const p12 = parseFloat(config.promo12) || 0;
                if(precioBaseActual > 0 && p4 > 0) {
                      const avgUnit = (precioBaseActual + (p4/4) + (p8/8) + (p12/12)) / 4;
                      document.getElementById('inputPrecioPromedio').value = avgUnit.toFixed(2);
                }

                recalcularPremios();
            }
        });

        window.guardarConfiguracion = function() {
            const datos = {
                titulo: document.getElementById('confTitulo').value,
                fecha: document.getElementById('confFecha').value,
                hora: document.getElementById('confHora').value,
                totalCartones: parseInt(document.getElementById('confTotalCartones').value),
                precioBase: parseFloat(document.getElementById('confPrecioBase').value),
                promo4: parseFloat(document.getElementById('confPromo4').value),
                promo8: parseFloat(document.getElementById('confPromo8').value),
                promo12: parseFloat(document.getElementById('confPromo12').value),
                usarDescuentos: document.getElementById('toggleDescuentos').checked,
                modoMantenimiento: document.getElementById('mantenimientoToggle').checked // NUEVO: Guardamos estado del switch de mantenimiento
            };
            configRef.set(datos).then(() => alert("‚úÖ Configuraci√≥n actualizada."));
        };

        cartonesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            todosLosDatos = data || {}; 
            const tabla = document.getElementById('tablaCuerpo');
            tabla.innerHTML = '';
            totalVendidosCount = 0;

            if (data) {
                const lista = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                lista.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                lista.forEach(item => {
                    if (item.estado === 'vendido') { 
                        totalVendidosCount++;
                        const esVerificado = item.verificado === true;
                        const claseFila = esVerificado ? 'row-verificado' : '';
                        const badgeEstado = esVerificado 
                            ? '<span class="badge badge-verificado"><i class="fas fa-check-circle"></i> Verificado</span>' 
                            : '<span class="badge badge-pendiente"><i class="fas fa-clock"></i> Pendiente</span>';

                        let mensajeWS = `Hola ${item.nombre}, te escribo de Calipso Bingo referente a tu cart√≥n #${item.id}...`;
                        const btnWhatsapp = `<a href="javascript:void(0)" onclick="abrirWhatsApp('${item.telefono}', '${mensajeWS}')" class="btn btn-success btn-sm btn-action" title="Chat WhatsApp"><i class="fab fa-whatsapp"></i></a>`;
                        const botonAccion = esVerificado
                            ? `<button class="btn btn-warning btn-sm btn-action" title="Desmarcar" onclick="toggleVerificado('${item.id}', false)"><i class="fas fa-undo"></i></button>`
                            : `<button class="btn btn-success btn-sm btn-action" title="Confirmar Pago" onclick="toggleVerificado('${item.id}', true)"><i class="fas fa-check"></i></button>`;

                        const tr = document.createElement('tr');
                        tr.className = claseFila;
                        tr.innerHTML = `<td><strong>#${item.id}</strong></td><td>${item.nombre}</td>
                            <td><small class="d-block text-muted">${item.telefono}</small><span class="fw-bold text-primary">Ref: ${item.referencia}</span></td>
                            <td>${badgeEstado}</td>
                            <td class="text-end">${btnWhatsapp}${botonAccion}<button class="btn btn-outline-danger btn-sm btn-action" onclick="liberar('${item.id}')"><i class="fas fa-times"></i></button></td>`;
                        tabla.appendChild(tr);
                    }
                });

                if (!primeraCarga && totalVendidosCount > totalVentasAnterior) {
                    const audio = new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3'); 
                    audio.volume = 0.5;
                    audio.play().catch(e => console.log("Audio bloqueado"));
                }
                totalVentasAnterior = totalVendidosCount;
                primeraCarga = false;
            } else {
                tabla.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">No hay ventas registradas.</td></tr>';
            }
            recalcularPremios();
            filtrarTabla();
        });

        function filtrarTabla() {
            const texto = document.getElementById('buscadorVentas').value.toLowerCase();
            const filtro = document.getElementById('filtroEstado').value;
            const filas = document.querySelectorAll('#tablaCuerpo tr');
            filas.forEach(fila => {
                if(fila.cells.length < 2) return;
                const textoFila = fila.innerText.toLowerCase();
                const esVerificado = fila.querySelector('.badge-verificado') !== null;
                const esPendiente = fila.querySelector('.badge-pendiente') !== null;
                let cumpleFiltro = true;
                if (filtro === 'pendientes' && !esPendiente) cumpleFiltro = false;
                if (filtro === 'verificados' && !esVerificado) cumpleFiltro = false;
                if (cumpleFiltro && !textoFila.includes(texto)) cumpleFiltro = false;
                fila.style.display = cumpleFiltro ? '' : 'none';
            });
        }

        window.recalcularPremios = function() {
            document.getElementById('totalVendidos').textContent = totalVendidosCount;
            document.getElementById('totalDisponibles').textContent = totalCartonesGlobal - totalVendidosCount;
            let porcentaje = totalCartonesGlobal > 0 ? (totalVendidosCount / totalCartonesGlobal) * 100 : 0;
            document.getElementById('lblPorcentaje').textContent = porcentaje.toFixed(1) + '% Vendido';
            document.getElementById('progressBar').style.width = porcentaje + '%';
            
            const precioPromedio = parseFloat(document.getElementById('inputPrecioPromedio').value) || precioBaseActual;
            const recaudadoTotal = totalVendidosCount * precioPromedio;
            document.getElementById('totalDinero').textContent = 'Bs ' + recaudadoTotal.toLocaleString('es-VE', {minimumFractionDigits: 2});

            const ganancia = recaudadoTotal * 0.30;
            const t1 = (recaudadoTotal * 0.10).toLocaleString('es-VE', {minimumFractionDigits: 2});
            const t2 = (recaudadoTotal * 0.10).toLocaleString('es-VE', {minimumFractionDigits: 2});
            const t3 = (recaudadoTotal * 0.15).toLocaleString('es-VE', {minimumFractionDigits: 2});
            const t4 = (recaudadoTotal * 0.35).toLocaleString('es-VE', {minimumFractionDigits: 2});

            valoresPremios.t1 = "Bs " + t1;
            valoresPremios.t2 = "Bs " + t2;
            valoresPremios.t3 = "Bs " + t3;
            valoresPremios.t4 = "Bs " + t4;

            document.getElementById('lblGanancia').textContent = 'Bs ' + ganancia.toLocaleString('es-VE', {minimumFractionDigits: 2});
            document.getElementById('prizeT1').textContent = valoresPremios.t1;
            document.getElementById('prizeT2').textContent = valoresPremios.t2;
            document.getElementById('prizeT3').textContent = valoresPremios.t3;
            document.getElementById('prizeT4').textContent = valoresPremios.t4;
            
            actualizarMontoPremio();
        }

        window.toggleVerificado = function(id, estado) { cartonesRef.child(id).update({ verificado: estado }); }
        window.liberar = function(id) { if(confirm('¬øEliminar venta del cart√≥n #' + id + '?')) cartonesRef.child(id).remove(); }
        window.reiniciarVentas = function() { if(confirm("‚ö†Ô∏è ¬øEst√°s seguro de borrar TODAS las ventas?")) { if(prompt("Escribe BORRAR para confirmar") === "BORRAR") cartonesRef.remove(); } }

        window.descargarExcel = function() {
            let csvContent = "data:text/csv;charset=utf-8,Carton;Nombre del Cliente\r\n";
            if(todosLosDatos) {
                const lista = Object.keys(todosLosDatos).map(key => ({ id: parseInt(key), ...todosLosDatos[key] }));
                lista.sort((a, b) => a.id - b.id);
                lista.forEach(item => {
                    if(item.estado === 'vendido') {
                        const nombreLimpio = (item.nombre || "Sin Nombre").replace(/;/g, " ");
                        csvContent += `${item.id};${nombreLimpio}\r\n`;
                    }
                });
            }
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "lista_simplificada_bingo.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>