<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Calipso Bingo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-family: 'Segoe UI', sans-serif; }
        .navbar { background: #1a5e3a !important; }
        .card-config { border-left: 5px solid #ffc107; }
        .btn-action { margin: 0 2px; }
        .row-verificado { background-color: #d1e7dd !important; } /* Fila Verde */
        .badge-verificado { background-color: #198754; }
        .badge-pendiente { background-color: #ffc107; color: #000; }
        
        /* ESTILOS PARA CALCULADORA DE PREMIOS */
        .prizes-panel { background-color: #2c3e50; color: white; padding: 20px; border-radius: 12px; margin-bottom: 25px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .prize-card { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center; border: 1px solid rgba(255,255,255,0.1); }
        .prize-card.grand-prize { background: linear-gradient(135deg, #FF6B35, #e55a2b); border: none; transform: scale(1.05); box-shadow: 0 5px 15px rgba(255, 107, 53, 0.4); }
        .prize-amount { font-size: 20px; font-weight: 800; display: block; margin-top: 5px; }
        .input-promedio { width: 80px; text-align: center; font-weight: bold; border-radius: 5px; border: none; padding: 2px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1"><i class="fas fa-cogs"></i> Panel de Control</span>
            <div class="d-flex gap-2">
                <a href="index.html" class="btn btn-outline-light btn-sm" target="_blank">
                    <i class="fas fa-external-link-alt"></i> Ver Tienda
                </a>
                <button class="btn btn-warning btn-sm fw-bold" onclick="window.location.href='index.html'">Salir</button>
            </div>
        </div>
    </nav>

    <div class="container">
        
        <div class="prizes-panel">
            <div class="d-flex justify-content-between align-items-center mb-3 border-bottom pb-2">
                <div>
                    <h5 class="m-0 fw-bold">ðŸ’° ESTRUCTURA DE PREMIOS (70%)</h5>
                    <small class="text-white-50">Tu Ganancia (30%): <span id="lblGanancia" class="fw-bold text-warning">Bs 0</span></small>
                </div>
                <div>
                    <small>Precio Promedio:</small>
                    <input type="number" id="inputPrecioPromedio" class="input-promedio" value="45" onchange="recalcularPremios()">
                </div>
            </div>
            <div class="row g-3">
                <div class="col-6 col-md-3">
                    <div class="prize-card">
                        <small class="text-uppercase text-white-50">1Âª Tanda (10%)</small>
                        <span class="prize-amount" id="prizeT1">Bs 0</span>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="prize-card">
                        <small class="text-uppercase text-white-50">2Âª Tanda (10%)</small>
                        <span class="prize-amount" id="prizeT2">Bs 0</span>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="prize-card">
                        <small class="text-uppercase text-white-50">3Âª Tanda (15%)</small>
                        <span class="prize-amount" id="prizeT3">Bs 0</span>
                    </div>
                </div>
                <div class="col-6 col-md-3">
                    <div class="prize-card grand-prize">
                        <small class="text-uppercase fw-bold">ðŸ‘‘ CARTÃ“N LLENO (35%)</small>
                        <span class="prize-amount" id="prizeT4">Bs 0</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm mb-4 card-config">
            <div class="card-header bg-white fw-bold">
                <i class="fas fa-edit"></i> ConfiguraciÃ³n General
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-5">
                        <label class="form-label">TÃ­tulo del Evento</label>
                        <input type="text" id="confTitulo" class="form-control" placeholder="Cargando...">
                    </div>
                    <div class="col-md-4">
                        <label class="form-label">SubtÃ­tulo (Fecha)</label>
                        <input type="text" id="confFecha" class="form-control">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-dark">ðŸ“¦ Cantidad Cartones</label>
                        <input type="number" id="confTotalCartones" class="form-control" placeholder="Ej: 1000">
                    </div>
                    
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-success">Precio Base (1)</label>
                        <input type="number" id="confPrecioBase" class="form-control" step="0.01">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-primary">Promo x 4</label>
                        <input type="number" id="confPromo4" class="form-control" step="0.01">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-primary">Promo x 8</label>
                        <input type="number" id="confPromo8" class="form-control" step="0.01">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold text-primary">Promo x 12</label>
                        <input type="number" id="confPromo12" class="form-control" step="0.01">
                    </div>

                    <div class="col-12 text-end">
                        <button class="btn btn-success fw-bold px-4" onclick="guardarConfiguracion()">
                            <i class="fas fa-save"></i> ACTUALIZAR DATOS
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card bg-white p-3 shadow-sm text-center border-0">
                    <h6 class="text-muted text-uppercase small">Total Vendidos</h6>
                    <h2 class="text-success fw-bold" id="totalVendidos">0</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white p-3 shadow-sm text-center border-0">
                    <h6 class="text-muted text-uppercase small">RecaudaciÃ³n Total (Est.)</h6>
                    <h2 class="text-primary fw-bold" id="totalDinero">Bs 0,00</h2>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card bg-white p-3 shadow-sm text-center border-0">
                    <h6 class="text-muted text-uppercase small">Disponibles</h6>
                    <h2 class="text-secondary fw-bold" id="totalDisponibles">...</h2>
                </div>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-12 d-flex justify-content-between">
                <button class="btn btn-success fw-bold" onclick="descargarExcel()">
                    <i class="fas fa-file-excel"></i> DESCARGAR LISTA SIMPLIFICADA
                </button>

                <button class="btn btn-outline-danger btn-sm" onclick="reiniciarJuego()">
                    <i class="fas fa-trash-alt"></i> BORRAR TODO Y REINICIAR
                </button>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-dark text-white fw-bold">
                <i class="fas fa-list"></i> GestiÃ³n de Ventas
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0 align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>CartÃ³n #</th>
                                <th>Cliente</th>
                                <th>TelÃ©fono / Referencia</th>
                                <th>Estado</th>
                                <th class="text-end">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="tablaCuerpo">
                            <tr><td colspan="5" class="text-center p-4 text-muted">Cargando datos...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <script>
        const password = prompt("Ingrese contraseÃ±a de administrador:");
        if (password !== "admin123") { window.location.href = "index.html"; }

        const firebaseConfig = {
            apiKey: "AIzaSyBtj_J5wQ4y-U3UDwwphud9Wir1n7WcI2s",
            authDomain: "calipsobingo-f532b.firebaseapp.com",
            databaseURL: "https://calipsobingo-f532b-default-rtdb.firebaseio.com",
            projectId: "calipsobingo-f532b",
            storageBucket: "calipsobingo-f532b.firebasestorage.app",
            messagingSenderId: "196074596826",
            appId: "1:196074596826:web:db6280789eb0d51ddd38e3",
            measurementId: "G-M9XK1H641N"
        };
        
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const cartonesRef = database.ref('cartones');
        const configRef = database.ref('configuracion');

        let precioBaseActual = 50;
        let totalCartonesGlobal = 1000;
        let totalVendidosCount = 0;
        let todosLosDatos = {}; 

        // --- CARGAR CONFIGURACIÃ“N ---
        configRef.on('value', (snapshot) => {
            const config = snapshot.val();
            if (config) {
                document.getElementById('confTitulo').value = config.titulo || '';
                document.getElementById('confFecha').value = config.fecha || '';
                document.getElementById('confTotalCartones').value = config.totalCartones || 1000;
                document.getElementById('confPrecioBase').value = config.precioBase || 0;
                document.getElementById('confPromo4').value = config.promo4 || 0;
                document.getElementById('confPromo8').value = config.promo8 || 0;
                document.getElementById('confPromo12').value = config.promo12 || 0;
                
                precioBaseActual = parseFloat(config.precioBase) || 0;
                totalCartonesGlobal = parseInt(config.totalCartones) || 1000;
                
                recalcularPremios();
            }
        });

        // --- GUARDAR CONFIGURACIÃ“N ---
        window.guardarConfiguracion = function() {
            const datos = {
                titulo: document.getElementById('confTitulo').value,
                fecha: document.getElementById('confFecha').value,
                totalCartones: parseInt(document.getElementById('confTotalCartones').value),
                precioBase: parseFloat(document.getElementById('confPrecioBase').value),
                promo4: parseFloat(document.getElementById('confPromo4').value),
                promo8: parseFloat(document.getElementById('confPromo8').value),
                promo12: parseFloat(document.getElementById('confPromo12').value)
            };

            configRef.set(datos)
                .then(() => alert("âœ… ConfiguraciÃ³n guardada correctamente."))
                .catch((error) => alert("âŒ Error: " + error.message));
        };

        // --- GESTIÃ“N DE VENTAS ---
        cartonesRef.on('value', (snapshot) => {
            const data = snapshot.val();
            todosLosDatos = data || {}; 
            const tabla = document.getElementById('tablaCuerpo');
            tabla.innerHTML = '';
            totalVendidosCount = 0;

            if (data) {
                const lista = Object.keys(data).map(key => ({ id: key, ...data[key] }));
                lista.sort((a, b) => new Date(b.fecha) - new Date(a.fecha));

                lista.forEach(item => {
                    if (item.estado === 'vendido') { 
                        totalVendidosCount++;
                        
                        const esVerificado = item.verificado === true;
                        const claseFila = esVerificado ? 'row-verificado' : '';
                        const badgeEstado = esVerificado 
                            ? '<span class="badge badge-verificado"><i class="fas fa-check-circle"></i> Verificado</span>' 
                            : '<span class="badge badge-pendiente"><i class="fas fa-clock"></i> Pendiente</span>';

                        const botonAccion = esVerificado
                            ? `<button class="btn btn-warning btn-sm btn-action" title="Desmarcar" onclick="toggleVerificado('${item.id}', false)"><i class="fas fa-undo"></i></button>`
                            : `<button class="btn btn-success btn-sm btn-action" title="Confirmar Pago" onclick="toggleVerificado('${item.id}', true)"><i class="fas fa-check"></i></button>`;

                        const tr = document.createElement('tr');
                        tr.className = claseFila;
                        tr.innerHTML = `
                            <td><strong>#${item.id}</strong></td>
                            <td>${item.nombre}</td>
                            <td>
                                <small class="d-block text-muted">${item.telefono}</small>
                                <span class="fw-bold text-primary">Ref: ${item.referencia}</span>
                            </td>
                            <td>${badgeEstado}</td>
                            <td class="text-end">
                                ${botonAccion}
                                <button class="btn btn-outline-danger btn-sm btn-action" title="Eliminar" onclick="liberar('${item.id}')"><i class="fas fa-times"></i></button>
                            </td>
                        `;
                        tabla.appendChild(tr);
                    }
                });
            } else {
                tabla.innerHTML = '<tr><td colspan="5" class="text-center p-4 text-muted">No hay ventas registradas.</td></tr>';
            }
            recalcularPremios();
        });

        // --- FUNCIONES MATEMÃTICAS ---
        window.recalcularPremios = function() {
            document.getElementById('totalVendidos').textContent = totalVendidosCount;
            document.getElementById('totalDisponibles').textContent = totalCartonesGlobal - totalVendidosCount;
            
            const precioPromedio = parseFloat(document.getElementById('inputPrecioPromedio').value) || precioBaseActual;
            const recaudadoTotal = totalVendidosCount * precioPromedio;
            document.getElementById('totalDinero').textContent = 'Bs ' + recaudadoTotal.toLocaleString('es-VE', {minimumFractionDigits: 2});

            // DistribuciÃ³n: 30% Ganancia, 70% Premios
            const ganancia = recaudadoTotal * 0.30;
            const t1 = recaudadoTotal * 0.10;
            const t2 = recaudadoTotal * 0.10;
            const t3 = recaudadoTotal * 0.15;
            const t4 = recaudadoTotal * 0.35;

            document.getElementById('lblGanancia').textContent = 'Bs ' + ganancia.toLocaleString('es-VE', {minimumFractionDigits: 2});
            document.getElementById('prizeT1').textContent = 'Bs ' + t1.toLocaleString('es-VE', {minimumFractionDigits: 2});
            document.getElementById('prizeT2').textContent = 'Bs ' + t2.toLocaleString('es-VE', {minimumFractionDigits: 2});
            document.getElementById('prizeT3').textContent = 'Bs ' + t3.toLocaleString('es-VE', {minimumFractionDigits: 2});
            document.getElementById('prizeT4').textContent = 'Bs ' + t4.toLocaleString('es-VE', {minimumFractionDigits: 2});
        }

        window.toggleVerificado = function(id, estado) {
            cartonesRef.child(id).update({ verificado: estado });
        }

        window.liberar = function(id) {
            if(confirm('Â¿Eliminar venta del cartÃ³n #' + id + '? QuedarÃ¡ libre de nuevo.')) {
                cartonesRef.child(id).remove();
            }
        }

        window.reiniciarJuego = function() {
            if(confirm("âš ï¸ Â¿EstÃ¡s seguro de borrar TODAS las ventas?")) {
                if(prompt("Escribe BORRAR para confirmar") === "BORRAR") {
                    cartonesRef.remove();
                }
            }
        }

        // --- FUNCIÃ“N EXCEL SIMPLIFICADA (SOLO CARTÃ“N Y NOMBRE EN ORDEN NUMÃ‰RICO) ---
        window.descargarExcel = function() {
            let csvContent = "data:text/csv;charset=utf-8,";
            // Encabezados Simplificados
            csvContent += "Carton;Nombre del Cliente\r\n";

            if(todosLosDatos) {
                // 1. Convertir objeto a array de objetos
                const lista = Object.keys(todosLosDatos).map(key => ({ id: parseInt(key), ...todosLosDatos[key] }));
                
                // 2. Ordenar numÃ©ricamente por ID de CartÃ³n (1, 2, 3...)
                lista.sort((a, b) => a.id - b.id);

                // 3. Generar filas
                lista.forEach(item => {
                    if(item.estado === 'vendido') {
                        // Limpiar comas para no romper el CSV
                        const nombreLimpio = (item.nombre || "Sin Nombre").replace(/;/g, " ");
                        
                        // Solo CartÃ³n y Nombre
                        const fila = `${item.id};${nombreLimpio}`;
                        csvContent += fila + "\r\n";
                    }
                });
            }

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "lista_simplificada_bingo.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>